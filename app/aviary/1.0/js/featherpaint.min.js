if(typeof AV=="undefined"){AV={}}AV.Actions=function(){this.actionList=[];this.index=-1;return this};AV.Actions.prototype.undoImplicitActions=function(){while(this.index>=0&&this.actionList[this.index][2].implicit===true&&!this.isACheckpoint()){var undoAction=this.actionList[this.index][0];var undoFunc=undoAction[0];var undoObj=undoAction[1];var undoArgs=undoAction[2];undoFunc.apply(undoObj,undoArgs);this.index--}};AV.Actions.prototype.canUndo=function(){if(AV.launchData.forceCropPreset&&this.index<=1){return false}var canUndo=this.index>=0;if(this.index===0&&this.actionList[0][2].implicit===true){canUndo=false}return canUndo};AV.Actions.prototype.undo=function(){var undoAction,undoFunc,undoObj,undoArgs,dims;if(this.index<0||this.isACheckpoint()){return}do{if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}undoAction=this.actionList[this.index][0];if(undoAction){undoFunc=undoAction[0];undoObj=undoAction[1];undoArgs=undoAction[2];undoFunc.apply(undoObj,undoArgs)}if(this.index>0){dims=this.actionList[this.index-1][3];if(dims){this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}else{this.setDims(this._origHiresWidth,this._origHiresHeight)}this.index--}while(this.index>=0&&!this.isACheckpoint()&&this.actionList[this.index][2].implicit===true);if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.undoFake=function(){var dims;if(this.index<0||this.isACheckpoint()){return}if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}if(this.index>0){dims=this.actionList[this.index-1][3];if(dims){this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}else{this.setDims(this._origHiresWidth,this._origHiresHeight)}this.index--;if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.undoToCheckpoint=function(){var undoAction,undoFunc,undoObj,undoArgs,dims;if(this.index<0){return}if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}do{undoAction=this.actionList[this.index][0];undoFunc=undoAction[0];undoObj=undoAction[1];undoArgs=undoAction[2];undoFunc.apply(undoObj,undoArgs);if(this.index>0){dims=this.actionList[this.index-1][3];if(dims){this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}else{this.setDims(this._origHiresWidth,this._origHiresHeight)}this.index--}while(this.index>=0&&!this.isACheckpoint());if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.canRedo=function(){return this.index<this.actionList.length-1};AV.Actions.prototype.redo=function(){var redoAction,redoFunc,redoObj,redoArgs,dims;if(this.index>=this.actionList.length-1){return}do{if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}this.index++;redoAction=this.actionList[this.index][1];if(redoAction){redoFunc=redoAction[0];redoObj=redoAction[1];redoArgs=redoAction[2];redoFunc.apply(redoObj,redoArgs);dims=this.actionList[this.index][3];if(dims){this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}}while(this.index<this.actionList.length-1&&this.actionList[this.index][2].implicit===true);if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.redoFake=function(){var nextItem,dims;if(this.index>=this.actionList.length-1){return}if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}nextItem=this.actionList[this.index+1];if(nextItem){dims=nextItem[3];if(dims){this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}this.index++;if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.redoToCheckpoint=function(){var redoAction,redoFunc,redoObj,redoArgs,dims,futureIndex,hasFutureCheckpoint=false;if(this.index>=this.actionList.length-1){return true}futureIndex=this.index;do{futureIndex++;hasFutureCheckpoint=this.isACheckpoint(futureIndex)}while(!hasFutureCheckpoint&&futureIndex<this.actionList.length-1);if(!hasFutureCheckpoint){return false}if(AV.paintWidgetInstance){AV.paintWidgetInstance.dirty=true}do{this.index++;redoAction=this.actionList[this.index][1];if(redoAction){redoFunc=redoAction[0];redoObj=redoAction[1];redoArgs=redoAction[2];redoFunc.apply(redoObj,redoArgs);dims=this.actionList[this.index][3];this.setDims(dims.hiresWidth||dims.width,dims.hiresHeight||dims.height)}}while(this.index<this.actionList.length-1&&!this.isACheckpoint());if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}return true};AV.Actions.prototype.push=function(undo,redo,redoSerializable,hiresDimsOverride,flags){flags=flags||{};var hiresDims;this.truncate(true);hiresDims=hiresDimsOverride||this.getDims();this.actionList.push([undo,redo,flags,hiresDims,redoSerializable])};AV.Actions.prototype.setCheckpoint=function(checkpoint){if(this.index<0){return}this.actionList[this.index][2].checkpoint=checkpoint};AV.Actions.prototype.isACheckpoint=function(index){index=index!==undefined?index:this.index;if(this.actionList[index]){return!!this.actionList[index][2].checkpoint}else{return false}};AV.Actions.prototype.isImplicit=function(implicit){if(this.index<0){return}this.actionList[this.index][2].implicit=implicit};AV.Actions.prototype.truncate=function(suppressNotification){this.actionList.length=this.index+1;if(!suppressNotification&&AV.controlsWidgetInstance){AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"updateUndoRedo",[this.canUndo(),this.canRedo()])}};AV.Actions.prototype.getDims=function(){var wh=null;if(AV.paintWidgetInstance){wh=wh||{};wh.width=AV.paintWidgetInstance.width;wh.height=AV.paintWidgetInstance.height}if(this.hiresWidth&&this.hiresHeight){wh=wh||{};wh.hiresWidth=this.hiresWidth;wh.hiresHeight=this.hiresHeight}return wh};AV.Actions.prototype.setDims=function(w,h){if(this.hiresWidth!=w||this.hiresHeight!=h){this.hiresWidth=w;this.hiresHeight=h;if(AV.controlsWidgetInstance){AV.controlsWidgetInstance.imageSizeTracker.setImageScaledIndicator()}}};AV.Actions.prototype.setOrigSize=function(w,h){this._origHiresWidth=w;this._origHiresHeight=h;this.setDims(w,h)};AV.Actions.prototype.exportJSON=function(simplify){var origWidth,origHeight;if(AV.paintWidgetInstance){var owh=AV.paintWidgetInstance.getOrigSize();origWidth=owh.width;origHeight=owh.height}var jsonObj={metadata:{imageorigsize:[origWidth,origHeight]}};var action;var redoJSONObj;var i,j;var actionlistSimp;var addIndex;var actionName;var actionLayerId;var addAction;var newAction;var deleteList;var layerTracker;var actionlist=[];if(AV.isRelaunched&&AV.prevActionList){var previous=JSON.parse(AV.prevActionList);if(previous){actionlist=previous.actionlist.slice()}}actionlist.push({action:"setfeathereditsize",width:origWidth,height:origHeight});for(i=0;i<this.index+1;i++){action=this.actionList[i];redoJSONObj=action[4];if(!redoJSONObj){continue}if(redoJSONObj.length==undefined){actionlist.push(redoJSONObj)}else{for(j=0;j<redoJSONObj.length;j++){actionlist.push(redoJSONObj[j])}}}if(simplify){addIndex={};actionlistSimp=[];actionlistSimp.length=actionlist.length;for(i=0;i<actionlist.length;i++){action=AV.util.extend({},actionlist[i]);actionName=action.action;switch(actionName){case"addsticker":case"addtext":actionLayerId=action.id;addIndex[actionLayerId]=i;actionlistSimp[i]=action;break;case"setsticker":actionLayerId=action.id;addAction=actionlist[addIndex[actionLayerId]];newAction={};newAction.action=addAction.action;newAction.url=addAction.url;newAction.urls=addAction.urls;newAction.size=addAction.size;newAction.external=addAction.external;newAction.id=addAction.id;newAction.center=action.center;newAction.scale=action.scale;newAction.rotation=action.rotation;actionlistSimp[i]=newAction;break;case"settext":actionLayerId=action.id;addAction=actionlist[addIndex[actionLayerId]];newAction={};newAction.action=addAction.action;newAction.id=addAction.id;newAction.text=addAction.text;newAction.font=addAction.font;newAction.size=addAction.size;newAction.color=addAction.color;newAction.shadowcolor=addAction.shadowcolor;newAction.center=action.center;newAction.scale=action.scale;newAction.rotation=action.rotation;actionlistSimp[i]=newAction;break;default:actionlistSimp[i]=action;break}}deleteList={};for(i=actionlistSimp.length-1;i>=0;i--){action=actionlistSimp[i];actionName=action.action;switch(actionName){case"deletetext":case"deletesticker":actionLayerId=action.id;deleteList[actionLayerId]=true;actionlistSimp.splice(i,1);break;case"addtext":case"addsticker":actionLayerId=action.id;if(deleteList[actionLayerId]){actionlistSimp.splice(i,1)}else{deleteList[actionLayerId]=true}delete action.id;break}}jsonObj["actionlist"]=actionlistSimp}else{jsonObj["actionlist"]=actionlist}if(jsonObj&&jsonObj.actionlist&&jsonObj.actionlist.length){var list=jsonObj.actionlist;for(var i=0;i<list.length;i++){if(list[i].action=="addsticker"){if(list[i].url&&list[i].url.indexOf("https://")==0){list[i].url=list[i].url.replace("https://","http://");for(var ii=0;ii<list[i].urls.length;ii++){list[i].urls[ii]=list[i].urls[ii].replace("https://","http://")}}}}}return AV.JSON.stringify(jsonObj)};AV.Actions.prototype.importJSON=function(jsonString,callback){if(!jsonString){if(callback){callback()}return false}if(!AV.paintWidgetInstance){if(callback){callback()}return false}var origWidth,origHeight;var jsonObj,actionlist=[];var _actions=this;var i,j,actionlistLength;try{jsonObj=AV.JSON.parse(jsonString);if(jsonObj){actionlist=jsonObj.actionlist}}catch(probablyAParseError){if(callback){callback()}return false}actionlistLength=actionlist.length;var enhanceNames={labcorrect:true,backlightenhance:true,nightenhance:true,autoenhance:true};var convertEnhanceAction=function(actionObject){var actionName=actionObject.action;for(var effectName in enhanceNames){if(effectName===actionName){actionObject.id=actionName;actionObject.action="enhance";return true}}return false};var processItem=function(actionObject){convertEnhanceAction(actionObject);var actionName=actionObject.action;switch(actionName){case"addsticker":actionName="overlay";break;case"addtext":if(actionObject.align){actionName="textwithfont"}else{actionName="text"}break;case"tools":actionName=actionObject.toolname;if(actionName=="tiltshift"){actionName="focus"}break;case"rotate":actionName="straighten";break;case"colortemp":actionName="warmth";break;case"sharpness":actionName="sharpen";break;case"redeye2":actionName="redeye";break;case"whiten2":actionName="whiten";break;case"selectiveblur":actionName="blemish";break;case"imageborders":actionName="frames";break;default:break}if(AV.paintWidgetInstance.module[actionName]&&AV.paintWidgetInstance.module[actionName]["readAction"]){AV.paintWidgetInstance.moduleLoaded(actionName,function(toolName){AV.paintWidgetInstance.setMode(actionName);AV.paintWidgetInstance.module[actionName]["readAction"].apply(this,[actionObject,nextItem])})}else{nextItem()}};var nextItem=function(){_actions.setCheckpoint(true);i++;if(i<actionlistLength){processItem(actionlist[i])}else{if(callback){callback()}AV.paintWidgetInstance.setMode(null)}};i=0;nextItem();return true};!function(AV,window,document){AV.FilterManager=function(){var urls=[];var utils={};var borders={};var flares={};var tools={};var effects={};var idToEffect={};var filterPacks={};var loadingUrls={};var api=this;var _haveNotSeenUrl=function(url){var i,len=urls.length;for(i=0;i<len;i++){if(urls[i]===url){return false}}urls.push(url);return true};var _haveNotLoadedUrl=function(url){return!!loadingUrls[url]};var _fireAllCallbacksForUrl=function(url){var i,len,callback;if(loadingUrls[url]&&loadingUrls[url].length){len=loadingUrls[url].length;for(i=0;i<len;i++){callback=loadingUrls[url][i];if(callback){callback.call()}}}delete loadingUrls[url]};var _addCallbackForUrl=function(url,callback){loadingUrls[url]=loadingUrls[url]||[];loadingUrls[url].push(callback)};var _gatherProclistEffects=function(id,packs){var i,pack,effects,packLen;if(packs){for(i=0;i<packs.length;i++){pack=packs[i];if(pack&&pack["codename"]&&pack["codename"]+"_effects"===id){effects=pack.items;if(effects){filterPacks[id]=effects;packLen=effects.length;for(var j=0;j<packLen;j++){idToEffect[effects[j]["identifier"]]=effects[j]}}packs.splice(i,1);break}}}};api.getEffectById=function(id){return idToEffect[id]};api.getClickableFiltersForPack=function(id){return filterPacks[id]};api.loadPack=function(packId,url,callback){var onComplete=function(){_gatherProclistEffects(packId,AV.proclistPacks);if(callback)callback.call(this)};if(url&&_haveNotSeenUrl(url)){_addCallbackForUrl(url,onComplete);AV.util.loadFile(url,"js",function(ev){_fireAllCallbacksForUrl(url)})}else{if(_haveNotLoadedUrl(url)){_addCallbackForUrl(url,onComplete)}else{onComplete()}}};return api}}(window["AV"]||(window["AV"]={}),window,document);!function(exports){exports["AV"]=exports["AV"]||{};var AV=exports["AV"];AV.ImageBorderManager=function(){var urls=[];var idToEffect={};var filterPacks={};var api=this;var _haveNotSeenUrl=function(url){var i,len=urls.length;for(i=0;i<len;i++){if(urls[i]===url){return false}}urls.push(url);return true};var _gatherFilters=function(id,packs){var i,j,clickable,packlen,borderObj;if(packs){for(i=0;i<packs.length;i++){filterPacks[id]=packs[i];packlen=packs[i].length;for(j=0;j<packlen;j++){borderObj=packs[i][j];idToEffect[borderObj.border_name]=borderObj}}packs.splice(0,i+1)}};api.getEffectById=function(id){return idToEffect[id]};api.getClickableFiltersForPack=function(id){return filterPacks[id]};api.tileBorder=function(frameName,callback){var item=api.getEffectById(frameName);var itemImages=item.images;var imageObj0=new Image;var imageObj1=new Image;var imageObj2=new Image;var imageObj3=new Image;var imageObj4=new Image;var imageObj5=new Image;var imageObj6=new Image;var imageObj7=new Image;var tileNames=["tl","tr","br","bl","l","t","r","b"];var tileImgs=[imageObj0,imageObj1,imageObj2,imageObj3,imageObj4,imageObj5,imageObj6,imageObj7];var imagesToLoad=[];var tilesObj={};for(var i=0;i<tileNames.length;i++){var prop=tileNames[i];tilesObj[prop]={w:itemImages[prop].width,h:itemImages[prop].height,img:tileImgs[i]};imagesToLoad.push({img:tileImgs[i],src:itemImages[prop].src})}AV.util.loadImagesSync(imagesToLoad,function(){if(callback){callback.apply(this,[tilesObj])}})};api.loadPack=function(packId,url,callback){if(url&&_haveNotSeenUrl(url)){AV.util.loadFile(url,"js",function(ev){_gatherFilters(packId,AV["borderPacks"]);if(callback)callback.call(this)})}else{_gatherFilters(packId,AV["borderPacks"]);if(callback)callback.call(this)}};return api};return exports}(this);!function(AV,window,document){AV.OverlayRegistry=function(){var _registry={};var _loadSticker=function(url,callback){var hiResURL=url;var imgElementClean=document.createElement("img");imgElementClean.fullimageurl=hiResURL;var onload_handler=function(e){avpw$(imgElementClean).unbind("load",onload_handler);api.addElement(url,imgElementClean);if(callback){callback.apply(this,[e])}};avpw$(imgElementClean).load(onload_handler);avpw$(imgElementClean).attr("src",url)};var api=this;api.add=function(id,hiresurl){if(!_registry[id]){_registry[id]={}}if(hiresurl){_registry[id].hiresurl=hiresurl}};api.addElement=function(id,cleanImage){if(!_registry[id]){api.add(id)}_registry[id].element=cleanImage};api.getElement=function(id,callback){var el=null;if(!_registry[id]||!_registry[id].element){if(callback){_loadSticker(id,callback)}}else{el=_registry[id].element;if(callback){callback.apply(this,[el])}}return el};api.getHiRes=function(id){return _registry[id].hiresurl};return api}}(window["AV"]||(window["AV"]={}),window,document);!function(AV,window,document){var mediator=AV.Events;AV.ModeManager=function(){var _this=this;var activateCanvasForMode=function(mode){_this.setCurrentLayerByName("background");_this.uiLayerShow(false);if(_this.active!==null){if(_this.active.deactivate!==undefined){_this.active.deactivate()}}if(mode!==null&&mode!==undefined&&mode!==""){var newactive=_this.module[mode];if(newactive!==undefined){_this.active=newactive;if(_this.active.activate!==undefined){_this.active.activate(_this)}}}else{_this.active=null}};var init=function(context){if(context){_this=context}mediator.on("canvas:activate",activateCanvasForMode)};var shutdown=function(){mediator.off("canvas:activate",activateCanvasForMode)};var api={};api.init=init;api.shutdown=shutdown;return api}}(window["AV"]||(window["AV"]={}),window,document);!function(exports,window,document){exports["AV"]=exports["AV"]||{};var AV=exports["AV"];var mediator=AV.Events;!function($){$.support.touch=$.support.touch||"ontouchend"in document}(avpw_jQuery);AV.PaintUI=function(canvas,eventsCanvas){var $canvas=avpw$(canvas);var $eventsCanvas=avpw$(eventsCanvas);var _registry={};var _events=["mouseOutEvent","mouseMoveEvent","mouseDownEvent","mouseUpEvent"];var _canvasOffset;var _moveReady=true;var _MOVE_DELAY=30;var _panEnabled=true;var _canvasMouseIsDown=false;var api=this;var _noOp=function(){};var _getCoords=function(ev){_canvasOffset=_canvasOffset||$canvas.offset();var x,y,canvasX,canvasY,touch,frac;if(ev.type=="internal"){x=ev.x;y=ev.y}else{touch=AV.util.getTouch(ev);if(touch){x=touch.pageX;y=touch.pageY}else{x=ev.pageX;y=ev.pageY}}canvasX=x-_canvasOffset.left;canvasY=y-_canvasOffset.top;canvasControlsX=canvasX;canvasControlsY=canvasY;frac=api.viewport.getRatio();canvasX=canvasX*frac;canvasY=canvasY*frac;return{x:x|0,y:y|0,canvasX:canvasX|0,canvasY:canvasY|0,canvasControlsX:canvasControlsX,canvasControlsY:canvasControlsY}};var _isWithinCanvasByBounds=function(x,y){var frac=api.viewport.getRatio();var cpos=$canvas.offset();var x0=cpos.left;var x1=x0+$canvas.width()/frac;var y0=cpos.top;var y1=y0+$canvas.height()/frac;return x>x0&&x<x1&&y>y0&&y<y1};api.enablePan=function(){_panEnabled=true;api.viewport.clearAvailablePanDirections();api.viewport.pan()};api.disablePan=function(){_panEnabled=false;api.hidePan()};api.showPan=function(){if(_panEnabled){api.addCanvasClass("avpw_can_pan")}};api.hidePan=function(){api.removeCanvasClass("avpw_can_pan")};var PAN_RATE=20;var _panTimer=null;var _panBusy=false;var _startCoords;var _canvasPanned=function(x,y){_panBusy=true;var dx=x-_startCoords.x;var dy=y-_startCoords.y;api.viewport.pan(dx,dy);var lastCoords={x:x,y:y};window.clearTimeout(_panTimer);_panTimer=window.setTimeout(function(){_panBusy=false;_startCoords=lastCoords},PAN_RATE)};var ZOOM_RATE=20;var _zoomTimer=null;var _zoomBusy=false;var _canvasZoomed=function(scale){_zoomBusy=true;api.viewport.gestureZoomUpdate(scale);window.clearTimeout(_zoomTimer);_zoomTimer=window.setTimeout(function(){_zoomBusy=false},ZOOM_RATE)};var _canvasGestureChanged=function(ev){if(ev.scale&&!_zoomBusy){_canvasZoomed(ev.scale)}return false};var _onModeChange=function(mode){api.setMouseCursor();if(avpw$.support.touch){if(mode==null){$eventsCanvas.bind("gesturechange",_canvasGestureChanged).bind("gestureend",api.viewport.gestureZoomFinish)}else{$eventsCanvas.unbind("gesturechange").unbind("gestureend")}}};var _canvasMouseOut=function(ev){if(_registry["mouseOutEvent"]){_registry["mouseOutEvent"].apply(api,[{},ev])}};var _canvasMouseMove=function(ev){var coords;if(_moveReady){_moveReady=false;window.setTimeout(function(){_moveReady=true},_MOVE_DELAY);if(_registry["mouseMoveEvent"]){coords=_getCoords(ev);return _registry["mouseMoveEvent"].apply(api,[coords,ev])}else{if(_panEnabled&&_canvasMouseIsDown){coords=_getCoords(ev);ev.preventDefault();_startCoords=_startCoords||coords;if(!_panBusy){_canvasPanned(coords.x,coords.y)}}}}};var _canvasMouseDown=function(ev){if(_registry["mouseDownEvent"]){var coords=_getCoords(ev);return _registry["mouseDownEvent"].apply(api,[coords,ev,_isWithinCanvasByBounds(coords.x,coords.y)])}else{if(_panEnabled){_startCoords=undefined;_canvasMouseIsDown=true;if(api.canvasHasClass("avpw_can_pan")){api.addCanvasClass("avpw_is_panning")}}}};var _canvasMouseUp=function(ev){if(_registry["mouseUpEvent"]){var coords=_getCoords(ev);_registry["mouseUpEvent"].apply(api,[coords,ev])}else{if(_panEnabled){_canvasMouseIsDown=false;if(api.viewport.isZoomed()){api.viewport.bounceBack()}api.removeCanvasClass("avpw_is_panning")}}};api.resetOffset=function(){_canvasOffset=undefined};api.getCoordinatesFromEventWithinCanvasBounds=function(ev){var coords=_getCoords(ev);return _isWithinCanvasByBounds(coords.x,coords.y)?coords:null};api.getCoordinatesFromEvent=function(ev){return _getCoords(ev)};api.getViewportCenter=function(){var viewportOffset,viewportEl,w,h;viewportEl=AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"getEmbedElement");if(viewportEl){viewportEl=avpw$(viewportEl);w=viewportEl.width();h=viewportEl.height();viewportOffset=viewportEl.offset();return _getCoords({type:"internal",x:w/2+viewportOffset.left,y:h/2+viewportOffset.top})}else{return null}};api.subscribe=function(module){for(var i=0;i<_events.length;i++){if(module[_events[i]]){_registry[_events[i]]=module[_events[i]].AV_bindInst(module)}}api.disablePan()};api.unsubscribe=function(module){_registry={};api.enablePan()};api.shutdown=function(){mediator.off("layout:resize",api.resetOffset);$eventsCanvas.unbind("mouseleave").unbind("mousedown");avpw$(window).unbind("mousemove",_canvasMouseMove).unbind("mouseup",_canvasMouseUp).unbind("scroll",api.resetOffset);if(avpw$.support.touch){$eventsCanvas.unbind("touchmove").unbind("touchstart").unbind("touchend").unbind("gesturechange").unbind("gestureend");avpw$(window).unbind("touchmove",_noOp)}api.resetOffset();api.viewport.shutdown();_registry={};_canvasMouseIsDown=false};api.setMouseCursor=function(cur){if(cur===undefined){cur=""}canvas.style.cursor=cur};api.addCanvasClass=function(className){$canvas.addClass(className)};api.removeCanvasClass=function(className){$canvas.removeClass(className)};api.canvasHasClass=function(className){return $canvas.hasClass(className)};mediator.on("tool:open",_onModeChange);mediator.on("layout:resize",api.resetOffset);$eventsCanvas.bind("mouseleave",_canvasMouseOut).bind("mousedown",_canvasMouseDown);avpw$(window).bind("mouseup",_canvasMouseUp).bind("mousemove",_canvasMouseMove).bind("scroll",api.resetOffset);if(avpw$.support.touch){avpw$(window).bind("touchmove",_noOp);$eventsCanvas.bind("touchstart",function(ev){avpw$(window).unbind("mousemove",_canvasMouseMove);$eventsCanvas.bind("touchmove",_canvasMouseMove);return _canvasMouseDown(ev)}).bind("touchend",function(ev){$eventsCanvas.unbind("touchmove",_canvasMouseMove);avpw$(window).bind("mousemove",_canvasMouseMove);_canvasMouseUp(ev);return false});$eventsCanvas.bind("gesturechange",_canvasGestureChanged).bind("gestureend",api.viewport.gestureZoomFinish)}api.viewport.setCanvas.apply(api,[canvas]);return api};AV.PaintUI.prototype.viewport=function(){var _paintUI,_canvas,api={};var _realDOMWidth,_zoomDelta;var viewportBbox=null,zoomedCanvasBbox=null;var _innerPadding=0;var _lastCanvasRatio=1;var _possiblePanDirections;var _getPanDirections=function(){var zoomedCanvasX1=zoomedCanvasBbox.x0+zoomedCanvasBbox.w,zoomedCanvasY1=zoomedCanvasBbox.y0+zoomedCanvasBbox.h,x=false,y=false;if(zoomedCanvasX1>viewportBbox.w||zoomedCanvasBbox.x0<viewportBbox.x0){x=true}if(zoomedCanvasBbox.y0<viewportBbox.y0||zoomedCanvasY1>viewportBbox.h){y=true}if(x||y){_paintUI.showPan()}else{_paintUI.hidePan()}return{x:x,y:y}};var TRANSFORM_PROPERTY=AV.support.getVendorProperty("transform");var _transform=function(args){if(TRANSFORM_PROPERTY&&(AV.launchData["openType"]=="mobile"||AV.launchData["openType"]=="aviary")){var scale=args&&args.scale?args.scale:1/api.getRatio();var centerOffsetX=.5*(zoomedCanvasBbox.w*1/scale-zoomedCanvasBbox.w)+.5|0;var centerOffsetY=.5*(zoomedCanvasBbox.h*1/scale-zoomedCanvasBbox.h)+.5|0;var x=zoomedCanvasBbox.x0-centerOffsetX;var y=zoomedCanvasBbox.y0-centerOffsetY;var style=new AV.TransformStyle(_canvas.style[TRANSFORM_PROPERTY]);style.set({translate:x+"px, "+y+"px",scale:scale});_canvas.style[TRANSFORM_PROPERTY]=style.serialize()}else{_canvas.style.width=zoomedCanvasBbox.w+"px";_canvas.style.height=zoomedCanvasBbox.h+"px";_canvas.style.marginLeft="-"+(zoomedCanvasBbox.w/2+.5|0)+"px";_canvas.style.marginTop="-"+(zoomedCanvasBbox.h/2+.5|0)+"px"}};api.setCanvas=function(canvas){_canvas=canvas;_paintUI=this;if(TRANSFORM_PROPERTY){_paintUI.addCanvasClass("avpw_position_by_transform")}};api.shutdown=function(){_realDOMWidth=_zoomDelta=undefined;viewportBbox=zoomedCanvasBbox=null};var _setZoomDelta=function(){_zoomDelta=Math.abs((_realDOMWidth-zoomedCanvasBbox.w)/2)+.5|0};var _zoomByIncrement=function(inc){if(inc){var w=zoomedCanvasBbox.w+_zoomDelta*inc,h=w*_canvas.height/_canvas.width+.5|0;if(h<0||w<0){return false}zoomedCanvasBbox.w=w;zoomedCanvasBbox.h=h;_centerCanvas();_clearAvailablePanDirections()}};var _lastScale=1;var _supportsAnimation=!!AV.support.getVendorProperty("transformStyle");api.gestureZoomUpdate=function(scale){_lastScale=scale;scale=scale*1/api.getRatio();_transform({scale:scale})};api.gestureZoomFinish=function(){if(_lastScale){var w=zoomedCanvasBbox.w*_lastScale+.5|0,h=zoomedCanvasBbox.h*_lastScale+.5|0,wOverH=w/h;if(w<viewportBbox.w&&h<viewportBbox.h){if(w>wOverH*h){zoomedCanvasBbox.w=viewportBbox.w;zoomedCanvasBbox.h=viewportBbox.w*h/w+.5|0}else{zoomedCanvasBbox.h=viewportBbox.h;zoomedCanvasBbox.w=viewportBbox.h*wOverH+.5|0}}else{zoomedCanvasBbox.w=w;zoomedCanvasBbox.h=h}_transform()}};api.setPadding=function(val){_innerPadding=val};var _setScale=function(maxWidth,maxHeight,clamp){var canvasWidth=_canvas.width;var canvasHeight=_canvas.height;var canvasWidthOverHeight=canvasWidth/canvasHeight;var zoomedDims;maxWidth=maxWidth||canvasWidth;maxHeight=maxHeight||canvasHeight;maxWidth-=_innerPadding;maxHeight-=_innerPadding;_realDOMWidth=canvasWidth;if(clamp){zoomedDims=AV.util.getScaledDims(canvasWidth,canvasHeight,maxWidth,maxHeight);maxWidth=zoomedDims.width;maxHeight=zoomedDims.height}zoomedCanvasBbox=new AV.Bbox(0,0,maxWidth,maxHeight);_setZoomDelta();_clearAvailablePanDirections()};var _pan=function(x,y,force){_possiblePanDirections=_possiblePanDirections||_getPanDirections();var doThePan=false;if(force||_possiblePanDirections.x){zoomedCanvasBbox.x0+=x;doThePan=true}if(force||_possiblePanDirections.y){zoomedCanvasBbox.y0+=y;doThePan=true}return doThePan};var _clearAvailablePanDirections=function(){_possiblePanDirections=undefined};var _bounceBack=function(){var zoomedCanvasX1=zoomedCanvasBbox.x0+zoomedCanvasBbox.w,zoomedCanvasY1=zoomedCanvasBbox.y0+zoomedCanvasBbox.h,overshot;if(zoomedCanvasX1>viewportBbox.w&&zoomedCanvasBbox.x0>viewportBbox.x0){overshot=viewportBbox.w-zoomedCanvasBbox.w;zoomedCanvasBbox.x0=overshot>0?overshot:0}else if(zoomedCanvasBbox.x0<viewportBbox.x0&&zoomedCanvasX1<viewportBbox.w){overshot=viewportBbox.w-zoomedCanvasBbox.w;zoomedCanvasBbox.x0=overshot<0?overshot:0}if(zoomedCanvasY1>viewportBbox.h&&zoomedCanvasBbox.y0>viewportBbox.y0){overshot=viewportBbox.h-zoomedCanvasBbox.h;zoomedCanvasBbox.y0=overshot>0?overshot:0}else if(zoomedCanvasBbox.y0<viewportBbox.x0&&zoomedCanvasY1<viewportBbox.h){overshot=viewportBbox.h-zoomedCanvasBbox.h;zoomedCanvasBbox.y0=overshot<0?overshot:0}return _pan(0,0)};var _centerCanvas=function(){if(!viewportBbox){return}var centerOffsetX=(viewportBbox.w-zoomedCanvasBbox.w)/2+.5|0;var centerOffsetY=(viewportBbox.h-zoomedCanvasBbox.h)/2+.5|0;zoomedCanvasBbox.x0=zoomedCanvasBbox.y0=0;_pan(centerOffsetX,centerOffsetY,true)};var _rotateBoundsBy90=function(angle){if(angle%180&&!(angle%90)){var w=zoomedCanvasBbox.w;zoomedCanvasBbox.w=zoomedCanvasBbox.h;zoomedCanvasBbox.h=w;_centerCanvas();return true}else{return false}};var _onCanvasResized=function(){var newCanvasRatio=api.getRatio();mediator.trigger("canvas:resize",zoomedCanvasBbox,newCanvasRatio,_lastCanvasRatio);_lastCanvasRatio=newCanvasRatio};api.isZoomed=function(){return api.getRatio()!==1};api.getRatio=function(){return zoomedCanvasBbox?_realDOMWidth/zoomedCanvasBbox.w:1};api.zoomIn=function(){if(!zoomedCanvasBbox){_setScale()}_zoomByIncrement(1);_transform();_paintUI.resetOffset();_onCanvasResized();return false};api.zoomOut=function(){if(!zoomedCanvasBbox){_setScale()}_zoomByIncrement(-1);_transform();_paintUI.resetOffset();_onCanvasResized();return false};api.zoomByRatio=function(ratio){var newW=_canvas.width*ratio;var newH=_canvas.height*ratio;var oldW=zoomedCanvasBbox.w;var oldH=zoomedCanvasBbox.h;var panX=0;var panY=0;zoomedCanvasBbox.w=newW+.5|0;zoomedCanvasBbox.h=newH+.5|0;_possiblePanDirections=_getPanDirections();if(_possiblePanDirections.x){panX=-((newW-oldW)/2+.5|0)}else{panX=(viewportBbox.w-zoomedCanvasBbox.w)/2+.5|0;zoomedCanvasBbox.x0=0}if(_possiblePanDirections.y){panY=-((newH-oldH)/2+.5|0)}else{panY=(viewportBbox.h-zoomedCanvasBbox.h)/2+.5|0;zoomedCanvasBbox.y0=0}_pan(panX,panY,true);_bounceBack();_transform();_paintUI.resetOffset();_clearAvailablePanDirections();_onCanvasResized();return false};api.fitLayout=function(w,h){viewportBbox=new AV.Bbox(0,0,w,h);_setScale(w,h,true);_centerCanvas();_transform();_paintUI.resetOffset();_onCanvasResized()};api.resize=function(w,h){_setScale(w,h,true);_centerCanvas();_transform();_paintUI.resetOffset();_onCanvasResized();return false};api.resizeFake=function(w,h){_setScale(w,h);_centerCanvas();_transform();_paintUI.resetOffset();return false};api.pan=function(x,y,force){if(_pan(x,y,force)){_transform();_paintUI.resetOffset()}};api.clearAvailablePanDirections=function(){_clearAvailablePanDirections()};api.bounceBack=function(){if(_bounceBack()){_transform();_paintUI.resetOffset()}_onCanvasResized()};api.rotate=function(x,y,z){x=x?x+"deg":"0";y=y?y+"deg":"0";z=z?z+"deg":"0";var style=new AV.TransformStyle(_canvas.style[TRANSFORM_PROPERTY]);if(_supportsAnimation){style.set({rotateX:x,rotateY:y,rotateZ:z})}else{style.set({rotate:x})}_canvas.style[TRANSFORM_PROPERTY]=style.serialize()};api.rotateBoundsBy90=function(angle){if(_rotateBoundsBy90(angle)){_onCanvasResized();return true}else{return false}};return api}();return exports}(this,typeof window!=="undefined"?window:{},typeof document!=="undefined"?document:{});!function(AV,window,document){avpw$=typeof avpw$!=="undefined"?avpw$:{};AV.CropController=function(controls,paintWidget){var api=this;var _dragStart=null;var _dragCornerOffset={};var _forceAspect=false;var _wtoh=1;var _corner=-1;var _bbox;var _canvasBbox;var _cropUIElement;var _overlayModule;var lastW,lastH;var _setCanvasBounds=function(){_canvasBbox=new AV.Bbox(0,0,paintWidget.width,paintWidget.height)};var _unsetCanvasBounds=function(){_canvasBbox=null};var _storeRatio=function(){_wtoh=_bbox?Math.abs((_bbox.x1-_bbox.x0)/(_bbox.y1-_bbox.y0)):0};var _constrainBoundingBoxByPoint=function(xCoord,yCoord){var factor,constraint;if(_wtoh==0){return}var htow=1/_wtoh;if(_forceAspect){if(Math.abs((_bbox.x1-_bbox.x0)/(_bbox.y1-_bbox.y0))>_wtoh){factor=AV.math.sign(_bbox.y1-_bbox.y0)*Math.abs(_bbox.x1-_bbox.x0)*htow+.5|0;if(yCoord==="y1"){_bbox[yCoord]=_bbox.y0+factor}else{_bbox[yCoord]=_bbox.y1-factor}}else{factor=AV.math.sign(_bbox.x1-_bbox.x0)*Math.abs(_bbox.y1-_bbox.y0)*_wtoh+.5|0;if(xCoord==="x1"){_bbox[xCoord]=_bbox.x0+factor}else{_bbox[xCoord]=_bbox.x1-factor}}}constraint=_canvasBbox.constrain(_bbox[xCoord],_bbox[yCoord]);_bbox[xCoord]=constraint.x;_bbox[yCoord]=constraint.y;if(_forceAspect&&constraint.dirty){if(Math.abs((_bbox.x1-_bbox.x0)/(_bbox.y1-_bbox.y0))>_wtoh){factor=AV.math.sign(_bbox.x1-_bbox.x0)*Math.abs(_bbox.y1-_bbox.y0)*_wtoh+.5|0;if(xCoord==="x1"){_bbox[xCoord]=_bbox.x0+factor}else{_bbox[xCoord]=_bbox.x1-factor}}else{factor=AV.math.sign(_bbox.y1-_bbox.y0)*Math.abs(_bbox.x1-_bbox.x0)*htow+.5|0;if(yCoord==="y1"){_bbox[yCoord]=_bbox.y0+factor}else{_bbox[yCoord]=_bbox.y1-factor}}}};var _set_bboxByCorner=function(x,y){switch(_corner){case 1:_bbox.x1=x+_dragCornerOffset.x;
_bbox.y0=y-_dragCornerOffset.y;_constrainBoundingBoxByPoint("x1","y0");break;case 2:_bbox.x0=x-_dragCornerOffset.x;_bbox.y1=y+_dragCornerOffset.y;_constrainBoundingBoxByPoint("x0","y1");break;case 3:_bbox.x1=x+_dragCornerOffset.x;_bbox.y1=y+_dragCornerOffset.y;_constrainBoundingBoxByPoint("x1","y1");break;case 0:default:_bbox.x0=x-_dragCornerOffset.x;_bbox.y0=y-_dragCornerOffset.y;_constrainBoundingBoxByPoint("x0","y0");break}};var _move_bbox=function(dx,dy){var w,h;_bbox.x0+=dx;_bbox.x1+=dx;_bbox.y0+=dy;_bbox.y1+=dy;w=_bbox.x1-_bbox.x0;h=_bbox.y1-_bbox.y0;var topLeft=_canvasBbox.constrain(_bbox.x0,_bbox.y0);if(topLeft.dirty){_bbox.x0=topLeft.x;_bbox.y0=topLeft.y;_bbox.x1=_bbox.x0+w;_bbox.y1=_bbox.y0+h}var bottomRight=_canvasBbox.constrain(_bbox.x1,_bbox.y1);if(bottomRight.dirty){_bbox.x1=bottomRight.x;_bbox.y1=bottomRight.y;_bbox.x0=_bbox.x1-w;_bbox.y0=_bbox.y1-h}};var _cropFlipButton;var _cropToolTip,_tooltipW,_tooltipH;var _addCropUI=function(){_cropFlipButton=avpw$('<div id="avpw_crop_flip_button"></div>');controls.layoutNotify(AV.launchData["openType"],"getCanvasControlsElement").append(_cropFlipButton);_cropUIElement=avpw$(AV.template[AV.launchData.layout].cropLayer());controls.layoutNotify(AV.launchData["openType"],"getCanvasControlsElement").append(_cropUIElement);_cropToolTip=_cropUIElement.find("#avpw_crop_tooltip");_tooltipW=_cropToolTip.find("#avpw_crop_tooltip_w");_tooltipH=_cropToolTip.find("#avpw_crop_tooltip_h")};api.setToolTipValues=function(w,h){if(!_tooltipW||!_tooltipH)return;_tooltipW.html(w);_tooltipH.html(h)};var _removeCropUI=function(){_cropUIElement.remove();_cropUIElement=null;_cropFlipButton.remove();_cropFlipButton=null;_cropToolTip=_tooltipW=_tooltipH=null};var _drawCropUI=function(_bbox,shouldAnimate){var zoomScale=controls.canvasUI.viewport.getRatio();var left,top,w,h;if(_bbox.x0<_bbox.x1){left=_bbox.x0;w=_bbox.x1-_bbox.x0}else{left=_bbox.x1;w=_bbox.x0-_bbox.x1}if(_bbox.y0<_bbox.y1){top=_bbox.y0;h=_bbox.y1-_bbox.y0}else{top=_bbox.y1;h=_bbox.y0-_bbox.y1}_mediator.trigger("tool:crop:change",w,h);left=left/zoomScale+.5|0;top=top/zoomScale+.5|0;w=w/zoomScale+.5|0;h=h/zoomScale+.5|0;var style={left:left+"px",top:top+"px",width:w+"px",height:h+"px"};_cropUIElement.css(style)};var _mediator;api.activate=function(mediator){_bbox=new AV.Bbox;_setCanvasBounds();_overlayModule=new AV.OverlaySelectionModule(paintWidget);_forceAspect=false;_addCropUI();_mediator=mediator;controls.layoutNotify(AV.launchData["openType"],"showCanvasControlsElement")};api.deactivate=function(){_bbox=null;_unsetCanvasBounds();_overlayModule=null;controls.layoutNotify(AV.launchData["openType"],"hideCanvasControlsElement");_removeCropUI()};var toolTipPaddingH=60,toolTipPaddingV=60;api.updateUIDown=function(x,y){_cropToolTip.show();var bestDist=99999999,dist;var zoomScale=1;zoomScale=controls.canvasUI.viewport.getRatio();var hwidth=_overlayModule.getHandleImageWidth();var cutoff=zoomScale*(hwidth/2)*(hwidth/2)|0;_dragStart=null;paintWidget.uiLayerReset();paintWidget.uiLayerShow(true);_corner=-1;dist=AV.math.sqrDist(_bbox.x0,_bbox.y0,x,y);if(dist<bestDist&&dist<cutoff){_corner=0;bestDist=dist;_cropToolTip.css({top:-toolTipPaddingV,left:-toolTipPaddingH,right:"auto",bottom:"auto"})}dist=AV.math.sqrDist(_bbox.x1,_bbox.y0,x,y);if(dist<bestDist&&dist<cutoff){_corner=1;bestDist=dist;_cropToolTip.css({top:-toolTipPaddingV,left:"auto",right:-toolTipPaddingH,bottom:"auto"})}dist=AV.math.sqrDist(_bbox.x0,_bbox.y1,x,y);if(dist<bestDist&&dist<cutoff){_corner=2;bestDist=dist;_cropToolTip.css({top:"auto",left:-toolTipPaddingH,right:"auto",bottom:-toolTipPaddingV})}dist=AV.math.sqrDist(_bbox.x1,_bbox.y1,x,y);if(dist<bestDist&&dist<cutoff){_corner=3;bestDist=dist;_cropToolTip.css({top:"auto",left:"auto",right:-toolTipPaddingH,bottom:-toolTipPaddingV})}switch(_corner){case 0:_dragCornerOffset={x:x-_bbox.x0,y:y-_bbox.y0};break;case 3:_dragCornerOffset={x:_bbox.x1-x,y:_bbox.y1-y};break;case 1:_dragCornerOffset={x:_bbox.x1-x,y:y-_bbox.y0};break;case 2:_dragCornerOffset={x:x-_bbox.x0,y:_bbox.y1-y};break;default:_cropToolTip.hide();if(_bbox.contains(x,y)){_dragStart={x:x,y:y}}else{return false}break}return true};api.updateUIMove=function(x,y){var dx,dy;if(_dragStart!=null){dx=x-_dragStart.x;dy=y-_dragStart.y;_move_bbox(dx,dy);_dragStart.x=x;_dragStart.y=y}else{_set_bboxByCorner(x,y)}_overlayModule.drawCropSelectionBackground(_bbox);paintWidget.recomposite(0);_drawCropUI(_bbox)};api.apply=function(x,y){_cropToolTip.hide();var t;if(_bbox.x0>_bbox.x1){t=_bbox.x0;_bbox.x0=_bbox.x1;_bbox.x1=t}if(_bbox.y0>_bbox.y1){t=_bbox.y0;_bbox.y0=_bbox.y1;_bbox.y1=t}};api.flipIt=function(){api.setInitialSelectionByRatio(lastH/lastW)};api.setInitialSelectionTo=function(w,h){if(!_bbox)return;lastW=w;lastH=h;_bbox.x0=(paintWidget.canvas.width-w)/2+.5|0;_bbox.x1=_bbox.x0+w+.5|0;_bbox.y0=(paintWidget.canvas.height-h)/2+.5|0;_bbox.y1=_bbox.y0+h+.5|0;paintWidget.uiLayerReset();paintWidget.uiLayerShow(true);_overlayModule.drawCropSelectionBackground(_bbox);paintWidget.recomposite();_drawCropUI(_bbox,true)};api.setInitialSelectionByRatio=function(w2h){var margin=0;var w=paintWidget.canvas.width;var h=paintWidget.canvas.height;var borderTB=margin;var borderLR=margin;var normw=w-2*borderLR;var normh=h-2*borderTB;var neww;var newh;neww=normh*w2h;newh=normh;if(neww>normw){neww=normw;newh=normw/w2h}return api.setInitialSelectionTo(neww,newh)};api.setInitialSelection=function(){var l,r,t,b;if(_forceAspect){l=t=.12}else{l=.09;t=.18}r=1-l;b=1-t;_bbox.x0=paintWidget.canvas.width*l+.5|0;_bbox.x1=paintWidget.canvas.width*r+.5|0;_bbox.y0=paintWidget.canvas.height*t+.5|0;_bbox.y1=paintWidget.canvas.height*b+.5|0;paintWidget.uiLayerReset();paintWidget.uiLayerShow(true);_overlayModule.drawCropSelectionBackground(_bbox);paintWidget.recomposite();_drawCropUI(_bbox)};api.forceAspect=function(force){if(force){_storeRatio()}_forceAspect=force};api.isValidCrop=function(){if(Math.abs(_bbox.x0-_bbox.x1)===0||Math.abs(_bbox.y0-_bbox.y1)===0)return false;else return true};api.crop=function(){return _bbox};return api}}(window["AV"]||(window["AV"]={}),window,document);!function(AV,window,document){var mediator=AV.Events;avpw$=typeof avpw$!=="undefined"?avpw$:{};AV.OverlayController=function(controls,paintWidget,o){var modes=o.modes||{OFF_STATE:0};var _handlePosition=o.handlePosition||AV.OverlayController.HANDLE_POSITION.BOTTOM_LEFT;var _DRAG_THRESHOLD=5;var _MINIMUM_OVERLAY_WIDTH=o.minimumOverlaySize||20;var _MAXIMUM_OVERLAY_WIDTH=o.maximumOverlaySize||99999999;var _OVERLAY_BORDER_WIDTH=10;var _OVERLAY_EDITING_CLASS="avpw_selection_overlay_selected avpw_selection_overlay_editing";var _OVERLAY_DRAG_CLASS="avpw_selection_overlay_selected avpw_selection_overlay_dragonly";var TRANSFORM_PROPERTY=AV.support.getVendorProperty("transform");var _overlays;var _maxOverlayZIndex;var _currentOverlay;var _lastOverlayAddedID=null;var _clickButNotDragState=false;var _mouseDown=false;var _sizeMouseDown=false;var _initialRotation;var _forceDragMode=o.forceDragMode||false;var _resetAllOverlaysMode=function(exceptionOverlay){if(!exceptionOverlay||_currentOverlay!==exceptionOverlay){_currentOverlay=null}for(var overlay in _overlays){if(_overlays.hasOwnProperty(overlay)&&_overlays[overlay]!=exceptionOverlay){_setOverlayMode(_overlays[overlay],modes.OFF_STATE)}}};var _resizeAllOverlays=function(bbox,newRatio,oldRatio){var adjustedRatio;var overlay,overlayObject;if(newRatio!==oldRatio){newRatio=1/newRatio;oldRatio=1/oldRatio;adjustedRatio=newRatio/oldRatio;for(overlay in _overlays){overlayObject=_overlays[overlay];_moveOverlayToCoords(overlayObject,{x:overlayObject.topLeftX*adjustedRatio,y:overlayObject.topLeftY*adjustedRatio});_scaleOverlayByScale(overlayObject,adjustedRatio)}}};var _moveCurrentOverlayToTop=function(){_maxOverlayZIndex++;if(_currentOverlay&&_currentOverlay.element){_currentOverlay.zIndex=_maxOverlayZIndex;_currentOverlay.element.css("z-index",_maxOverlayZIndex)}};var _setCurrentOverlayById=function(id){_resetAllOverlaysMode(_overlays[id]);_currentOverlay=_overlays[id];_moveCurrentOverlayToTop()};var _saveDimensionsFromElement=function(element){var width,height,aspectRatio=o.aspectRatio,overlayObj=_overlays[element.id];width=element?parseInt(element.style.width,10):0;height=element?avpw$(element).height():0;var left=element?parseInt(element.style.left,10):0;var top=element?parseInt(element.style.top,10):0;var centerX=left+_OVERLAY_BORDER_WIDTH+width/2;var centerY=top+_OVERLAY_BORDER_WIDTH+height/2;if(!aspectRatio){if(width!==0&&height!==0){aspectRatio=height/width}else{aspectRatio=1}}if(overlayObj){AV.util.extend(overlayObj,{width:width,aspectRatio:aspectRatio,topLeftX:parseInt(element.style.left||0,10),topLeftY:parseInt(element.style.top||0,10),centerX:centerX,centerY:centerY})}};var _setOverlayMode=function(target,mode){target.mode=mode;target.element.removeClass(_OVERLAY_DRAG_CLASS);target.element.removeClass(_OVERLAY_EDITING_CLASS);if(mode===modes.DRAG_STATE){target.element.addClass(_OVERLAY_DRAG_CLASS)}else if(mode===modes.EDIT_STATE){target.element.addClass(_OVERLAY_EDITING_CLASS)}else{if(_currentOverlay&&_currentOverlay==target){_currentOverlay=null}}if(o.onModeChange){o.onModeChange.apply(controls,[target,mode])}};var _cycleOverlayMode=function(target,enable){if(target){if(!target.mode||target.mode===modes.OFF_STATE){if(enable&&modes.DRAG_STATE)_setOverlayMode(target,modes.DRAG_STATE)}else if(target.mode===modes.DRAG_STATE){if(enable){if(modes.EDIT_STATE){_setOverlayMode(target,modes.EDIT_STATE)}}else{_setOverlayMode(target,modes.OFF_STATE)}}else if(target.mode===modes.EDIT_STATE){if(!enable){if(modes.DRAG_STATE){_setOverlayMode(target,modes.DRAG_STATE)}else{_setOverlayMode(target,modes.OFF_STATE)}}}}};var _removeOverlay=function(overlay){if(overlay&&overlay.element){overlay.element.remove();delete _overlays[overlay.id]}};var _removeAllOverlays=function(){avpw$.each(_overlays,function(id){_removeOverlay(_overlays[id])})};var _moveOverlayToCoords=function(overlay,coords){overlay.element.css({left:coords.x+"px",top:coords.y+"px"});overlay.topLeftX=coords.x;overlay.topLeftY=coords.y};var _moveOverlay=function(overlay,coords){var initialCoordsX,initialCoordsY,dx,dy,overThreshold=false;initialCoordsX=overlay.initialCoordsX;initialCoordsY=overlay.initialCoordsY;dx=coords.x-initialCoordsX;dy=coords.y-initialCoordsY;if(Math.abs(dx)>_DRAG_THRESHOLD||Math.abs(dy)>_DRAG_THRESHOLD){overThreshold=true}if(overThreshold){overlay.element.css({left:overlay.topLeftX+dx+"px",top:overlay.topLeftY+dy+"px"})}return overThreshold};var _showCurrentOverlay=function(){if(_currentOverlay&&_currentOverlay.element){_currentOverlay.element.show()}};var _hideCurrentOverlay=function(){if(_currentOverlay&&_currentOverlay.element){_currentOverlay.element.hide()}};var _scaleOverlayByScale=function(overlay,scale){var width=overlay.width*scale;var height=width*overlay.aspectRatio;overlay.element.css({width:width+"px",height:height+"px"});overlay.width=width};var _scaleAndRotateOverlay=function(overlay,coords){var initialCoordsX,initialCoordsY,width,height,aspectRatio,topLeftX,topLeftY,centerX,centerY,handleX,handleY,handleNewX,handleNewY,canvasOffset,initialRotation,originalAngle,newAngle,scale,minScale,maxScale,rotation;topLeftX=overlay.topLeftX;topLeftY=overlay.topLeftY;initialCoordsX=overlay.initialCoordsX;initialCoordsY=overlay.initialCoordsY;canvasOffset=controls.layoutNotify(AV.launchData["openType"],"getCanvasControlsElement").offset();initialCoordsX-=canvasOffset.left;initialCoordsY-=canvasOffset.top;coords.x-=canvasOffset.left;coords.y-=canvasOffset.top;aspectRatio=overlay.aspectRatio;width=overlay.width;height=width*aspectRatio;if(_handlePosition==AV.OverlayController.HANDLE_POSITION.BOTTOM_LEFT){handleX=topLeftX;handleY=topLeftY+height+_OVERLAY_BORDER_WIDTH/2}else if(_handlePosition==AV.OverlayController.HANDLE_POSITION.BOTTOM_CENTER){handleX=topLeftX+width/2+_OVERLAY_BORDER_WIDTH;handleY=topLeftY+height+_OVERLAY_BORDER_WIDTH}else if(_handlePosition==AV.OverlayController.HANDLE_POSITION.BOTTOM_RIGHT){handleX=topLeftX+width+_OVERLAY_BORDER_WIDTH*2;handleY=topLeftY+height+_OVERLAY_BORDER_WIDTH*2}centerX=overlay.centerX;centerY=overlay.centerY;handleNewX=coords.x;handleNewY=coords.y;scale=Math.sqrt(Math.pow(handleNewX-centerX,2)+Math.pow(handleNewY-centerY,2))/Math.sqrt(Math.pow(handleX-centerX,2)+Math.pow(handleY-centerY,2));minScale=_MINIMUM_OVERLAY_WIDTH/width;maxScale=_MAXIMUM_OVERLAY_WIDTH/width;scale=scale>minScale?scale:minScale;scale=scale<maxScale?scale:maxScale;initialRotation=overlay.rotation||0;originalAngle=Math.atan2(handleY-centerY,handleX-centerX);if(initialRotation){originalAngle=initialRotation-(2*Math.PI-originalAngle)}newAngle=Math.atan2(handleNewY-centerY,handleNewX-centerX);rotation=newAngle-originalAngle+initialRotation;overlay.rotation=rotation;rotation=rotation*180/Math.PI+.5|0;overlay.element[0].style[TRANSFORM_PROPERTY]="rotate("+rotation+"deg)";overlay.element.css({left:(topLeftX-width*.5*(scale-1)+.5|0)+"px",top:(topLeftY-height*.5*(scale-1)+.5|0)+"px",width:(width*scale+.5|0)+"px",height:(height*scale+.5|0)+"px"});return scale};var _overlayRemoveClicked=function(parentOverlay,onRemoveMouseDown){var id,overlay;if(parentOverlay.length){id=parentOverlay[0].id;overlay=_overlays[id];if(overlay){if(onRemoveMouseDown){onRemoveMouseDown.apply(controls,[overlay])}_removeOverlay(overlay)}}};var _overlayMouseDown=function(element,onOverlayMouseDown){var targetOverlay=_overlays[element.attr("id")];var mouseDownOnCurrentOverlay=false;if(targetOverlay===_currentOverlay){mouseDownOnCurrentOverlay=true;_mouseDown=true}if(onOverlayMouseDown){onOverlayMouseDown.apply(controls,[targetOverlay,mouseDownOnCurrentOverlay])}return mouseDownOnCurrentOverlay};var _overlaySizeMouseDown=function(onSizeMouseDown){if(_currentOverlay){_sizeMouseDown=true;_initialRotation=_currentOverlay.rotation;if(onSizeMouseDown){onSizeMouseDown.apply(controls,[_currentOverlay])}}};var _overlayMouseUp=function(element){if(element){_saveDimensionsFromElement(element[0]);_setCurrentOverlayById(element.attr("id"))}};var _addOverlayToCanvas=function(overlay,callback){if(overlay&&overlay.element){_saveDimensionsFromElement(overlay.element[0]);if(callback){callback.apply(controls,[overlay])}}};var _addAllOverlaysToCanvas=function(callback){var i,len=_maxOverlayZIndex+1;var overlaysInOrder=new Array(len);avpw$.each(_overlays,function(id){overlaysInOrder[_overlays[id].zIndex]=_overlays[id]});for(i=0;i<len;i++){if(overlaysInOrder[i]){_addOverlayToCanvas(overlaysInOrder[i],callback)}}};var api=this;api.activate=function(){_maxOverlayZIndex=1;_overlays={};_lastOverlayAddedID=null;controls.layoutNotify(AV.launchData["openType"],"showCanvasControlsElement");mediator.on("canvas:resize",_resizeAllOverlays)};api.deactivate=function(){_removeAllOverlays();_overlays={};controls.layoutNotify(AV.launchData["openType"],"hideCanvasControlsElement");mediator.off("canvas:resize",_resizeAllOverlays)};api.updateUIDown=function(coords,ev,onOverlayMouseDown,onSizeMouseDown,onRemoveMouseDown,onClickOutside){var mouseDownOnCurrentOverlay=false;var $element=avpw$(ev.target);var $overlay=$element.closest(".avpw_selection_overlay");var $sizeHandle=$element.closest(".avpw_selection_overlay_size_handle");var $closeButton=$element.closest(".avpw_selection_overlay_close_button");if($closeButton&&$closeButton.length){_overlayRemoveClicked($overlay,onRemoveMouseDown);ev.preventDefault();return false}if($overlay&&$overlay.length){_clickButNotDragState=true;mouseDownOnCurrentOverlay=_overlayMouseDown($overlay,onOverlayMouseDown)}if($sizeHandle&&$sizeHandle.length){_overlaySizeMouseDown(onSizeMouseDown)}if(mouseDownOnCurrentOverlay){AV.util.extend(_currentOverlay,{initialCoordsX:coords.x,initialCoordsY:coords.y});_saveDimensionsFromElement($overlay[0])}else{if(_currentOverlay&&_currentOverlay.element){if(!_forceDragMode){_cycleOverlayMode(_currentOverlay,false)}if(onClickOutside){onClickOutside()}}}};api.updateUIMove=function(coords,ev,onMouseMoveStart,onScaleChanged,onOverlayDragMove){if(_mouseDown&&_currentOverlay&&_currentOverlay.element){if(_clickButNotDragState&&onMouseMoveStart){onMouseMoveStart.apply(controls,[_currentOverlay])}if(_sizeMouseDown){scale=_scaleAndRotateOverlay(_currentOverlay,coords);if(onScaleChanged){onScaleChanged.apply(controls,[_currentOverlay,scale])}_clickButNotDragState=false}else{if(_currentOverlay.mode===modes.DRAG_STATE){_clickButNotDragState=!_moveOverlay(_currentOverlay,coords);if(onOverlayDragMove){onOverlayDragMove()}}}}return false};api.apply=function(coords,ev,onMouseUp){var mouseDownOnCurrentOverlay=false;var $element=avpw$(ev.target);var $overlay=$element.closest(".avpw_selection_overlay");var targetOverlay;if($overlay&&$overlay.length){_overlayMouseUp($overlay);mouseDownOnCurrentOverlay=true;targetOverlay=_overlays[$overlay.attr("id")]}if(onMouseUp){onMouseUp.apply(controls,[targetOverlay,mouseDownOnCurrentOverlay,_sizeMouseDown])}if(_clickButNotDragState){_clickButNotDragState=false;if(_currentOverlay&&_currentOverlay.element&&!_forceDragMode){_cycleOverlayMode(_currentOverlay,true)}}_mouseDown=false;_sizeMouseDown=false};api.newOverlay=function(overlayObject){var overlayElement=overlayObject.element;_resetAllOverlaysMode();controls.layoutNotify(AV.launchData["openType"],"getCanvasControlsElement").append(overlayElement);_cycleOverlayMode(overlayObject,true);_overlays[overlayObject.id]=overlayObject;_saveDimensionsFromElement(overlayElement[0]);_currentOverlay=overlayObject;_lastOverlayAddedID=overlayObject.id;_moveCurrentOverlayToTop()};api.commit=function(callback){_addAllOverlaysToCanvas(callback)};api.currentOverlay=function(){return _currentOverlay};api.showCurrentOverlay=function(){_showCurrentOverlay()};api.hideCurrentOverlay=function(){_hideCurrentOverlay()};api.saveDimensions=function(overlay){overlay=overlay||_currentOverlay;_saveDimensionsFromElement(overlay.element[0])};api.isLastOverlayAdded=function(overlay){return _lastOverlayAddedID&&_overlays[_lastOverlayAddedID]===overlay};api.setHandlePosition=function(position_setting){_handlePosition=position_setting};api.setRotation=function(overlay,rotation){overlay.rotation=rotation;rotation=rotation*180/Math.PI+.5|0;overlay.element[0].style[TRANSFORM_PROPERTY]="rotate("+rotation+"deg)"};return api};AV.OverlayController.HANDLE_POSITION={BOTTOM_LEFT:0,BOTTOM_CENTER:1,BOTTOM_RIGHT:2}}(window["AV"]||(window["AV"]={}),window,document);!function(AV,window,document){var mediator=AV.Events;avpw$=typeof avpw$!=="undefined"?avpw$:{};AV.cnvs={clearCanvas:function(c){c.width=c.width},copyCanvas:function(src,x,y,w,h){var newCanvas=document.createElement("canvas");var cc;if(h===undefined){newCanvas.width=src.width;newCanvas.height=src.height;cc=newCanvas.getContext("2d");cc.drawImage(src,0,0)}else{newCanvas.width=w;newCanvas.height=h;cc=newCanvas.getContext("2d");cc.drawImage(src,-x,-y)}return newCanvas},drawImageCopy:function(context,image,x,y){var oldGCO=context.globalCompositeOperation;context.save();context.beginPath();context.rect(x,y,image.width,image.height);context.clip();context.closePath();context.globalCompositeOperation="copy";context.drawImage(image,x,y);context.globalCompositeOperation=oldGCO;context.restore()},getCanvasPixelData:function(c){var cc=c.getContext("2d");return cc.getImageData(0,0,c.width,c.height)},getImageDataRegion:function(can,x,y,w,h,pad){var cc;var tcan;var canWidth=can.width;var canHeight=can.height;var imageData;if(x<0||y<0||x+w>canWidth||y+h>canHeight){tcan=document.createElement("canvas");tcan.width=w;tcan.height=h;cc=tcan.getContext("2d");cc.drawImage(can,-x,-y);imageData=cc.getImageData(0,0,w,h);if(pad){var canCc=can.getContext("2d");var row0=canCc.getImageData(0,0,canWidth,1).data;var rowN=canCc.getImageData(0,canHeight-1,canWidth,1).data;var col0=canCc.getImageData(0,0,1,canHeight).data;var colN=canCc.getImageData(canWidth-1,0,1,canHeight).data;var pixels=imageData.data;for(var tcanY=0;tcanY<h;tcanY++){var row=null;var canY=tcanY+y;if(canY<0){canY=0;row=row0}if(canY>=canHeight){canY=canHeight-1;row=rowN}for(var tcanX=0;tcanX<w;tcanX++){var col=null;var canX=tcanX+x;if(canX<0){canX=0;col=col0}if(canX>=canWidth){canX=canWidth-1;col=colN}var tcanIndex=(tcanX+tcanY*w)*4;if(col){var colIndex=canY*4;pixels[tcanIndex++]=col[colIndex++];pixels[tcanIndex++]=col[colIndex++];pixels[tcanIndex++]=col[colIndex++];pixels[tcanIndex]=col[colIndex]}else if(row){var rowIndex=canX*4;pixels[tcanIndex++]=row[rowIndex++];pixels[tcanIndex++]=row[rowIndex++];pixels[tcanIndex++]=row[rowIndex++];pixels[tcanIndex]=row[rowIndex]}else{tcanX=canWidth-x-1}}}}}else{cc=can.getContext("2d");imageData=cc.getImageData(x,y,w,h)}return imageData},putImageDataRegion:function(can,data,x,y){var cc=can.getContext("2d");var tcc;var tcan;var canw=can.width;var canh=can.height;var dataw=data.width;var datah=data.height;if(x<0||y<0||x+dataw>=canw||y+datah>=canh){tcan=document.createElement("canvas");tcan.width=dataw;tcan.height=datah;tcc=tcan.getContext("2d");tcc.putImageData(data,0,0);cc.drawImage(tcan,x,y)}else{cc.putImageData(data,x,y)}},convertRgbToHsv:function(hsvs,rgbs,length){var i;var r,g,b;var hue,sat,val;for(i=0;i<length;i+=4){r=rgbs[i];g=rgbs[i+1];b=rgbs[i+2];var max=Math.max(r,Math.max(g,b));var min=Math.min(r,Math.min(g,b));val=max;if(max==0){hue=0;sat=0}else{var delta=max-min;sat=delta/max;if(r==max){hue=(g-b)/delta}else if(g==max){hue=2+(b-r)/delta}else{hue=4+(r-g)/delta}if(hue<0){hue+=6}hue*=60}hsvs[i]=hue;hsvs[i+1]=sat;hsvs[i+2]=val;hsvs[i+3]=rgbs[i+3]}},convertHsvToRgb:function(rgbs,hsvs,length){var i;var r,g,b;var hue,sat,val;for(i=0;i<length;i+=4){hue=hsvs[i];sat=hsvs[i+1];val=hsvs[i+2];r=g=b=val;if(sat!=0){hue/=60;var base=hue|0;var frac=hue-base;var dullest=1-sat;var dullerHi=1-sat*frac;var dullerLo=1-sat*(1-frac);switch(base){case 0:b*=dullest;g*=dullerLo;break;case 1:b*=dullest;r*=dullerHi;break;case 2:r*=dullest;b*=dullerLo;break;case 3:r*=dullest;g*=dullerHi;break;case 4:g*=dullest;r*=dullerLo;break;default:g*=dullest;b*=dullerHi}}if(r<0){r=0}if(r>255){r=255}if(g<0){g=0}if(g>255){g=255}if(b<0){b=0}if(b>255){b=255}rgbs[i]=r;rgbs[i+1]=g;rgbs[i+2]=b;rgbs[i+3]=hsvs[i+3]}},applyKernel1D:function(kernel,kernelMiddle,dest,destOffset,destStride,src,srcOffset,srcStride,count){var kernelLength=kernel.length;var i,k;var safeStart=kernelMiddle;var safeEnd=count-1-(kernelLength-kernelMiddle);for(i=0;i<count;i++){var r=0;var g=0;var b=0;if(i>=safeStart&&i<=safeEnd){var srcIndex=srcOffset+(i+(kernelLength-kernelMiddle)-1)*srcStride;var coeff;for(k=kernelLength-1;k>=3;){coeff=kernel[k--];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2];srcIndex-=srcStride;coeff=kernel[k--];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2];srcIndex-=srcStride;coeff=kernel[k--];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2];srcIndex-=srcStride;coeff=kernel[k--];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2];srcIndex-=srcStride}while(k>=0){coeff=kernel[k--];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2];srcIndex-=srcStride}}else{for(k=0;k<kernelLength;k++){var adjusted=i+(k-kernelMiddle);if(adjusted<0){adjusted=0}if(adjusted>=count){adjusted=count-1}var srcIndex=srcOffset+adjusted*srcStride;var coeff=kernel[k];r+=coeff*src[srcIndex];g+=coeff*src[srcIndex+1];b+=coeff*src[srcIndex+2]}}var destIndex=destOffset+i*destStride;dest[destIndex]=r;dest[destIndex+1]=g;dest[destIndex+2]=b}},shadowTransform:function(){var canvas=document.createElement("canvas");canvas.height=canvas.width=3;var offset=-1;var cc=canvas.getContext("2d");cc.shadowOffsetX=offset;cc.shadowOffsetY=offset;cc.shadowBlur=1;cc.shadowColor="red";cc.fillRect(1,1,1,1);var data=cc.getImageData(0,0,3,3).data;var transform={x:1,y:1};switch(255){case data[32]:transform.x=transform.y=-1;break;case data[24]:transform.y=-1;break;case data[8]:transform.x=-1;break;case data[0]:break}return transform}(),isOriginClean:function(canvasContext){var originClean=true;try{canvasContext.getImageData(0,0,1,1)}catch(err){if(err&&err.message){if(err.message.toLowerCase().indexOf("security")!==-1){originClean=false}}if(err&&err.name){if(err.name.toLowerCase().indexOf("security")!==-1){originClean=false}}}return originClean}};AV.math={sign:function(x){return x<0?-1:1},sqrDist:function(x0,y0,x1,y1){var dx=x1-x0;var dy=y1-y0;return dx*dx+dy*dy},solveQuadratic:function(a,b,c){var term1=-b;var term2=b*b-4*a*c;var term3=2*a;if(term2<0)return[0,0];return[(term1-Math.sqrt(term2))/term3,(term1+Math.sqrt(term2))/term3]},lowestPositiveQuadratic:function(a,b,c){var result=AV.math.solveQuadratic(a,b,c);var v0=result[0];var v1=result[1];if(v1<=0&&v0>0)return v0;if(v0<=0&&v1>0)return v1;return Math.max(Math.min(v0,v1),0)},lineSegmentIntersection:function(Ax,Ay,Bx,By,Cx,Cy,Dx,Dy,pointOfIntersection){var X,Y;var distAB,theCos,theSin,newX,ABpos;if(Ax==Bx&&Ay==By||Cx==Dx&&Cy==Dy)return null;if(Ax==Cx&&Ay==Cy||Bx==Cx&&By==Cy||Ax==Dx&&Ay==Dy||Bx==Dx&&By==Dy){return null}Bx-=Ax;By-=Ay;Cx-=Ax;Cy-=Ay;Dx-=Ax;Dy-=Ay;distAB=Math.sqrt(Bx*Bx+By*By);theCos=Bx/distAB;theSin=By/distAB;newX=Cx*theCos+Cy*theSin;Cy=Cy*theCos-Cx*theSin;Cx=newX;newX=Dx*theCos+Dy*theSin;Dy=Dy*theCos-Dx*theSin;Dx=newX;if(Cy<0&&Dy<0||Cy>=0&&Dy>=0)return null;ABpos=Dx+(Cx-Dx)*Dy/(Dy-Cy);if(ABpos<0||ABpos>distAB)return null;X=Ax+ABpos*theCos;Y=Ay+ABpos*theSin;pointOfIntersection.x=X;pointOfIntersection.y=Y;return true}};AV.Bbox=function(x0,y0,x1,y1,margin){if(y1!==undefined){this.x0=x0;this.y0=y0;this.x1=x1;this.y1=y1;this.w=this.x1-this.x0;this.h=this.y1-this.y0;if(margin!==undefined){this.margin=margin}else{this.margin=0}}else{this.reset()}};AV.Bbox.prototype.include=function(x,y){var minx=x-this.margin;var miny=y-this.margin;var maxx=x+this.margin;var maxy=y+this.margin;if(this.x0>minx){this.x0=minx}if(this.y0>miny){this.y0=miny}if(this.x1<maxx){this.x1=maxx}if(this.y1<maxy){this.y1=maxy}this.w=this.x1-this.x0;this.h=this.y1-this.y0};AV.Bbox.prototype.reset=function(){this.x0=999999999;this.y0=999999999;this.x1=-999999999;this.y1=-999999999;this.w=0;this.h=0;this.margin=0};AV.Bbox.prototype.contains=function(x,y){var t1=x>=this.x0&&x<=this.x1;var t2=y>=this.y0&&y<=this.y1;return t1&&t2};AV.Bbox.prototype.constrain=function(x,y){var dirty=false;if(x<this.x0){x=this.x0;dirty=true}if(x>this.x1){x=this.x1;dirty=true}if(y<this.y0){y=this.y0;dirty=true}if(y>this.y1){y=this.y1;dirty=true}return{x:x,y:y,dirty:dirty}};AV.Layer=function(info){this.image=this.canvas=this.drawable=null;if(info.image!==undefined){this.image=this.drawable=info.image;this.type="image"}else if(info.canvas!==undefined){this.canvas=this.drawable=info.canvas;this.type="canvas"}this.name=info.name;this.rotate=0;this.translateX=this.translateY=0;this.scaleX=this.scaleY=1};AV.Layer.prototype.worldToLocal=function(p){p.x-=this.translateX;p.y-=this.translateY;var cosa=Math.cos(-this.rotate);var sina=Math.sin(-this.rotate);var x=p.x;p.x=x*cosa-p.y*sina;p.y=x*sina+p.y*cosa;p.x/=this.scaleX;p.y/=this.scaleY};AV.Layer.prototype.localToWorld=function(p){if(this.centerX){p.x-=this.centerX}if(this.centerY){p.y-=this.centerY}p.x*=this.scaleX;p.y*=this.scaleY;var cosa=Math.cos(this.rotate);var sina=Math.sin(this.rotate);var x=p.x;p.x=x*cosa-p.y*sina;p.y=x*sina+p.y*cosa;p.x+=this.translateX;p.y+=this.translateY};AV.Layer.prototype.localPointIn=function(p){var x0=0,y0=0;if(this.centerX){x0-=this.centerX}if(this.centerY){y0-=this.centerY}return p.x>=x0&&p.y>=y0&&p.x<x0+this.drawable.width&&p.y<y0+this.drawable.height};AV.OverlaySelectionModule=function(context){var _paintWidget=context;var handleImg=document.createElement("img");handleImg.width=handleImg.height=50;var api=this;api.getHandleImageWidth=function(){return handleImg.width};api.drawCropSelection=function(_bbox){if(!_bbox){return}var x0,y0,x1,y1,w,h;var zoomScale=1;if(AV.controlsWidgetInstance&&AV.controlsWidgetInstance.canvasUI){zoomScale=AV.controlsWidgetInstance.canvasUI.viewport.getRatio()}var l=_paintWidget.getLayerByName("_ui");if(_bbox.x0<_bbox.x1){x0=_bbox.x0;x1=_bbox.x1}else{x0=_bbox.x1;x1=_bbox.x0}if(_bbox.y0<_bbox.y1){y0=_bbox.y0;y1=_bbox.y1}else{y0=_bbox.y1;y1=_bbox.y0}w=x1-x0;h=y1-y0;var c=l.canvas.getContext("2d");c.globalCompositeOperation="copy";c.clearRect(0,0,l.canvas.width,l.canvas.height);c.globalCompositeOperation="source-over";c.fillStyle="#000000";c.globalAlpha=.6;c.fillRect(0,0,x0,l.canvas.height);c.fillRect(x1,0,l.canvas.width,l.canvas.height);c.fillRect(x0,0,x1-x0,y0-0);c.fillRect(x0,y1,x1-x0,l.canvas.height-y1);c.strokeStyle="#f4f4f4";c.globalAlpha=1;c.lineWidth=zoomScale;c.lineCap="square";c.strokeRect(x0,y0,w,h);c.beginPath();c.moveTo(x0,y0+h*.33+.5|0);c.lineTo(x1,y0+h*.33+.5|0);c.moveTo(x0,y0+h*.67+.5|0);c.lineTo(x1,y0+h*.67+.5|0);c.moveTo(x0+w*.33+.5|0,y0);c.lineTo(x0+w*.33+.5|0,y1);c.moveTo(x0+w*.67+.5|0,y0);c.lineTo(x0+w*.67+.5|0,y1);c.stroke();c.closePath();c.globalAlpha=1;var handlePoints=[{x:x0,y:y0},{x:x1,y:y0},{x:x0,y:y1},{x:x1,y:y1}];for(var i=0;i<handlePoints.length;i++){var handlePoint=handlePoints[i];c.setTransform(1,0,0,1,0,0);l.localToWorld(handlePoint);c.translate(handlePoint.x,handlePoint.y);c.translate(-1*(zoomScale*handleImg.width/2+.5|0),-1*(zoomScale*handleImg.height/2+.5|0));c.scale(zoomScale,zoomScale);c.drawImage(handleImg,0,0);c.scale(1,1);c.setTransform(1,0,0,1,0,0)}};api.drawCropSelectionBackground=function(_bbox){if(!_bbox){return}var x0,y0,x1,y1,w,h;var l=_paintWidget.getLayerByName("_ui");if(_bbox.x0<_bbox.x1){x0=_bbox.x0;x1=_bbox.x1}else{x0=_bbox.x1;x1=_bbox.x0}if(_bbox.y0<_bbox.y1){y0=_bbox.y0;y1=_bbox.y1}else{y0=_bbox.y1;y1=_bbox.y0}w=x1-x0;h=y1-y0;var c=l.canvas.getContext("2d");c.globalCompositeOperation="copy";c.clearRect(0,0,l.canvas.width,l.canvas.height);c.globalCompositeOperation="source-over";c.fillStyle="#000000";c.globalAlpha=.6;c.fillRect(0,0,x0,l.canvas.height);c.fillRect(x1,0,l.canvas.width,l.canvas.height);c.fillRect(x0,0,x1-x0,y0-0);c.fillRect(x0,y1,x1-x0,l.canvas.height-y1)};return api};AV.BrushModule=function(o){var _overflow=o.overflow||0;var _layerName=o.layerName||"drawing";var _preserveBacking=o.preserveBacking||false;var _paintWidget;var _origBacking;var _radius=5;var _color="rgba(255,255,204,0.5)";var _erase=false;var _pointlist;var _bbox;var _oldX,_oldY;var _oldMidX,_oldMidY;var api=this;var _drawUICircle=function(x,y){_paintWidget.uiLayerDrawCircleSelection(x,y,_radius)};var _createLayerIfNecessary=function(){var layer=_paintWidget.getLayerByName(_layerName);if(!layer){var dcanvas=document.createElement("canvas");dcanvas.width=_paintWidget.width;dcanvas.height=_paintWidget.height;layer=new AV.Layer({canvas:dcanvas,name:_layerName});_paintWidget.addLayer(layer);_paintWidget.uiLayerReset()}if(layer.canvas.width!=_paintWidget.width){layer.canvas.width=_paintWidget.width}if(layer.canvas.height!=_paintWidget.height){layer.canvas.height=_paintWidget.height}return layer};var _resetSpotToolLayer=function(){var i=_paintWidget.findLayerIndexByName("spot_tool");if(i!==-1){_paintWidget.layers[i].canvas.width=_paintWidget.canvas.width;_paintWidget.layers[i].canvas.height=_paintWidget.canvas.height}};var _drawLineSegment=function(c,x,y,begin,end){c.lineCap="round";c.lineJoin="round";c.lineWidth=_radius*2;if(_erase){c.strokeStyle="#fff";c.globalCompositeOperation="destination-out"}else{c.strokeStyle=_color;c.globalCompositeOperation="source-over"}c.beginPath();if(begin){_oldX=x;_oldY=y;c.moveTo(_oldX,_oldY);c.lineTo(x+.02,y);_oldMidX=x;_oldMidY=y}else if(end){c.moveTo(_oldMidX,_oldMidY);c.lineTo(_oldX,_oldY);_oldX=_oldY=_oldMidX=_oldMidY=null}else{var midX=(_oldX+x)/2|0;var midY=(_oldY+y)/2|0;c.moveTo(_oldMidX,_oldMidY);c.quadraticCurveTo(_oldX,_oldY,midX,midY);_oldX=x;_oldY=y;_oldMidX=midX;_oldMidY=midY}c.stroke();c.closePath()};var _generatePointList=function(pointList){var brushSize=_radius;var lastpoint;var i=0;var midpoints=[];var getQuadMid=function(points,x0,y0,x1,y1,cpx,cpy){var distdist=(x1-x0)*(x1-x0)+(y1-y0)*(y1-y0);if(distdist<brushSize*brushSize){return null}var ax,bx,ay,by,mx,my;
if(cpx!==undefined){ax=(cpx+x0)/2;bx=(cpx+x1)/2;ay=(cpy+y0)/2;by=(cpy+y1)/2;mx=(ax+bx)/2;my=(ay+by)/2}else{mx=(x0+x1)/2;my=(y0+y1)/2}getQuadMid(points,x0,y0,mx,my,ax,ay);points.push([mx|0,my|0]);getQuadMid(points,mx,my,x1,y1,bx,by)};for(i=0;i<pointList.length-1;++i){var point1=pointList[i];var point2=pointList[i+1];var midpoint=[(point1[0]+point2[0])/2|0,(point1[1]+point2[1])/2|0];if(i===0){getQuadMid(midpoints,point1[0],point1[1],midpoint[0],midpoint[1])}else{getQuadMid(midpoints,lastpoint[0],lastpoint[1],midpoint[0],midpoint[1],point1[0],point1[1])}lastpoint=midpoint;midpoints.push(midpoint);if(i===pointList.length-2){getQuadMid(midpoints,midpoint[0],midpoint[1],point2[0],point2[1]);midpoints.push(point2)}}return midpoints};var _drawingUndo=function(layerName,backing,x,y){var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");AV.cnvs.drawImageCopy(c,backing,x,y);_paintWidget.recomposite()};var _drawingRedo=function(layerName,backing,x,y){var layer=_createLayerIfNecessary();var c=layer.canvas.getContext("2d");AV.cnvs.drawImageCopy(c,backing,x,y);_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget;_bbox=new AV.Bbox;_oldX=_oldY=0;_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true)};api.deactivate=function(){_paintWidget.uiLayerShow(false)};api.updateUIDown=function(x,y){var layer=_createLayerIfNecessary();_paintWidget.currentLayer=layer;if(_preserveBacking){_origBacking=AV.cnvs.copyCanvas(layer.canvas)}_paintWidget.uiLayerShow(true);_pointlist=[[x+.5|0,y+.5|0]];_bbox.reset();_bbox.margin=(_radius+.5|0)+_overflow;_bbox.include(x,y);var c=layer.canvas.getContext("2d");_drawLineSegment(c,x,y,true);_paintWidget.recomposite()};api.updateUIMove=function(x,y){_paintWidget.uiLayerShow(true);_drawUICircle(x,y);_paintWidget.recomposite()};api.updateUIDraw=function(x,y){var layer=_paintWidget.currentLayer;var c=layer.canvas.getContext("2d");_pointlist.push([x+.5|0,y+.5|0]);_drawLineSegment(c,x,y,false);_bbox.include(x,y);_paintWidget.uiLayerShow(true);_drawUICircle(x,y);_paintWidget.recomposite()};api.commit=function(moduleName,undoFunc,redoFunc,expand){var layer,backing;if(undoFunc&&redoFunc){var pointlist=expand&&_pointlist.length>1?_generatePointList(_pointlist):_pointlist;_resetSpotToolLayer();layer=_paintWidget.layers[_paintWidget.currentLayerIndex];if(!layer.canvas){return}backing=AV.cnvs.copyCanvas(layer.canvas,_bbox.x0,_bbox.y0,_bbox.w,_bbox.h);_paintWidget.actions.push([undoFunc,this,[layer.name,backing,_bbox.x0,_bbox.y0]],[redoFunc,this,[layer.name,pointlist,_radius]],{action:moduleName,radius:_radius+.5|0,pointlist:pointlist});_paintWidget.actions.redo()}else{layer=_paintWidget.currentLayer;var c=layer.canvas.getContext("2d");_drawLineSegment(c,0,0,false,true);_paintWidget.recomposite();backing=AV.cnvs.copyCanvas(layer.canvas,_bbox.x0,_bbox.y0,_bbox.w,_bbox.h);var origBackingCrop=AV.cnvs.copyCanvas(_origBacking,_bbox.x0,_bbox.y0,_bbox.w,_bbox.h);_paintWidget.actions.push([_drawingUndo,this,[layer.name,origBackingCrop,_bbox.x0,_bbox.y0]],[_drawingRedo,this,[layer.name,backing,_bbox.x0,_bbox.y0]],{action:moduleName,erase:_erase,radius:_radius+.5|0,softness:0,color:AV.util.color_to_rgb(_color),pointlist:_pointlist});_paintWidget.actions.redoFake()}_pointlist=null;_origBacking=null};api.radius=function(){return _radius};api.setRadius=function(r){_radius=r};api.setColor=function(c){_color=c};api.setErase=function(e){_erase=e};return api};AV.SpotBrushModule=function(o){var _processor=o.processor;var _params=o.params;var _toolName=o.toolName;var _origBackingCanvas,_origSrc,_newPixelData,src,dst,_tmp,_mask;var _oldLayers;var _toolStrokes;var _copyProcessor=AV.require("../../../src/js/processors/copy");var _paintWidget;var _strokeBacking;var _maskBacking;var _radius=5;var _pointlist;var _oldX,_oldY;var _oldMidX,_oldMidY;var api=this;var _currentPointList;var _lastPoint;var _shouldHideCursor=false;var _initializeImageDataFromCanvas=function(flatten){flatten||(flatten=true);var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];if(layer.canvas==null){return}_origBackingCanvas=AV.cnvs.copyCanvas(layer.canvas);if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.layers[_paintWidget.currentLayerIndex]}var dcanvas=AV.cnvs.copyCanvas(layer.canvas);var ctx=layer.canvas.getContext("2d");var w=_paintWidget.width,h=_paintWidget.height;_origSrc=AV.cnvs.getCanvasPixelData(dcanvas);src=_origSrc.data;_newPixelData=AV.cnvs.getCanvasPixelData(dcanvas);dst=_newPixelData.data;_tmp=AV.cnvs.getCanvasPixelData(dcanvas).data;_mask=_copyProcessor.makeData(w*h);_processor.init(_tmp,w,h,_mask);_processor.preview(dst,src,_tmp,_mask,w,h);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite();_pointlist=[]};var _drawUICircle=function(x,y){mediator.trigger("canvas:setBrushPosition",x,y)};var _generatePointList=function(pointList){var brushSize=Math.floor(_radius*.2)||1;var lastpoint;var i=0;var midpoints=[];var getQuadMid=function(points,x0,y0,x1,y1,cpx,cpy){var distdist=(x1-x0)*(x1-x0)+(y1-y0)*(y1-y0);if(distdist<brushSize*brushSize){return null}var ax,bx,ay,by,mx,my;if(cpx!==undefined){ax=(cpx+x0)/2;bx=(cpx+x1)/2;ay=(cpy+y0)/2;by=(cpy+y1)/2;mx=(ax+bx)/2;my=(ay+by)/2}else{mx=(x0+x1)/2;my=(y0+y1)/2}getQuadMid(points,x0,y0,mx,my,ax,ay);points.push([mx|0,my|0]);getQuadMid(points,mx,my,x1,y1,bx,by)};for(i=0;i<pointList.length-1;++i){var point1=pointList[i];var point2=pointList[i+1];var midpoint=[(point1[0]+point2[0])/2|0,(point1[1]+point2[1])/2|0];if(i===0){getQuadMid(midpoints,point1[0],point1[1],midpoint[0],midpoint[1])}else{getQuadMid(midpoints,lastpoint[0],lastpoint[1],midpoint[0],midpoint[1],point1[0],point1[1])}lastpoint=midpoint;midpoints.push(midpoint);if(i===pointList.length-2){getQuadMid(midpoints,midpoint[0],midpoint[1],point2[0],point2[1]);midpoints.push(point2)}}return midpoints};var _drawingUndo=function(layerName,backing,x,y){var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");AV.cnvs.drawImageCopy(c,backing,x,y);_paintWidget.recomposite()};api.reset=function(){_initializeImageDataFromCanvas(true)};api.activate=function(paintWidget){_paintWidget=paintWidget;_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true);_toolStrokes=[];api.reset();AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"showCanvasControlsElement")};api.deactivate=function(){_paintWidget.uiLayerShow(false);mediator.trigger("canvas:hideBrushCursor");_toolStrokes=null};var _applyDraw=function(x,y,scaledRadius){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");var w=_paintWidget.width,h=_paintWidget.height;var minX,minY,maxX,maxY;var paddedBrushRadius=scaledRadius*1.5;if(_lastPoint!=null){var distance=Math.sqrt(Math.pow(_lastPoint[0]-x,2)+Math.pow(_lastPoint[1]-y,2));if(distance<.6*_radius){return}var fillPoints=_generatePointList([[_lastPoint[0],_lastPoint[1]],[x,y]]);minX=x;minY=y;maxX=x;maxY=y;var xPos,yPos;for(var i=0;i<fillPoints.length;i++){xPos=fillPoints[i][0];yPos=fillPoints[i][1];if(xPos<minX){minX=xPos}if(xPos>maxX){maxX=xPos}if(yPos<minY){minY=yPos}if(yPos>maxY){maxY=yPos}api.drawPoint(xPos,yPos,xPos,yPos,w,h,scaledRadius)}}else{minX=x;minY=y;maxX=x;maxY=y}minX-=paddedBrushRadius;minY-=paddedBrushRadius;maxX+=paddedBrushRadius;maxY+=paddedBrushRadius;_currentPointList.push([x,y]);api.drawPoint(x,y,x,y,w,h,scaledRadius);_processor.preview(dst,src,_tmp,_mask,w,h,minX,minY,maxX,maxY);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};api.drawPoint=function(x,y,startX,startY,w,h,scaledRadius){var procParams=AV.util.extend({posX:x,posY:y,startX:startX,startY:startY,radius:scaledRadius},_params);_currentPointList.push([x,y]);_lastPoint=[x,y];_processor.draw(src,w,h,_mask,procParams)};api.startStroke=function(){_currentPointList=[]};api.updateUIDown=function(x,y,scaledRadius){_maskBacking=_copyProcessor.copy(_mask);if(!_shouldHideCursor){_paintWidget.uiLayerShow(true);_drawUICircle(x,y)}var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];if(!layer.canvas){return}_strokeBacking=AV.cnvs.getCanvasPixelData(layer.canvas);api.startStroke();_currentPointList.push([x,y]);_applyDraw(x,y,scaledRadius)};api.updateUIMove=function(x,y,mouseDown,scaledRadius){if(mouseDown){_applyDraw(x,y,scaledRadius);_currentPointList.push([x,y])}if(!_shouldHideCursor){_paintWidget.uiLayerShow(true);_drawUICircle(x,y)}_paintWidget.recomposite()};api.updateUIUp=function(){_lastPoint=null};var _applyImage=function(imageData){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];layer.canvas.getContext("2d").putImageData(imageData,0,0);_paintWidget.recomposite();_origSrc=AV.cnvs.getCanvasPixelData(layer.canvas);src=_origSrc.data;_newPixelData=AV.cnvs.getCanvasPixelData(layer.canvas);dst=_newPixelData.data;_mask=_copyProcessor.makeData(_paintWidget.width*_paintWidget.height)};var _undoStroke=function(mask,origSrc,oldLayers){_mask=mask;if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");_origSrc=origSrc;src=_origSrc.data;_processor.preview(dst,src,_tmp,_mask,layer.canvas.width,layer.canvas.height);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};var _redoStroke=function(mask){_mask=mask;_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");_origSrc=AV.cnvs.getCanvasPixelData(layer.canvas);src=_origSrc.data;_processor.preview(dst,src,_tmp,_mask,layer.canvas.width,layer.canvas.height);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};api.commitStroke=function(scaledRadius){var newMask=_copyProcessor.copy(_mask);var toolOrigSrc=AV.cnvs.getCanvasPixelData(_origBackingCanvas);_paintWidget.actions.push([_undoStroke,this,[_maskBacking,toolOrigSrc,_oldLayers]],[_redoStroke,this,[newMask]],{});_paintWidget.actions.redoFake();api.finializeStroke(scaledRadius)};api.finializeStroke=function(scaledRadius){_toolStrokes.push(AV.util.extend({},{radius:scaledRadius,pointlist:_currentPointList}))};api.commit=function(isHeadless){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");var dstCopy=ctx.getImageData(0,0,_paintWidget.width,_paintWidget.height);_paintWidget.actions.undoToCheckpoint();var origCopy=ctx.getImageData(0,0,_paintWidget.width,_paintWidget.height);_paintWidget.actions.push([_applyImage,this,[origCopy]],[_applyImage,this,[dstCopy]],api.getFlattenedActionList());_paintWidget.actions.redo()};api.getFlattenedActionList=function(){return{action:"tools",toolname:_toolName,strokes:_toolStrokes}};api.resetImageData=function(){_initializeImageDataFromCanvas(true)};api.radius=function(){return _radius};api.setRadius=function(r){_radius=r;mediator.trigger("canvas:setBrushSize",r)};return api};AV.SpotBrushModule.Cursor=function(){var api={};var _brushElm,_ctx;var _createBrush=function(){_brushElm=document.createElement("canvas");_brushElm.className="avpw_cursor_circle";_brushElm.width=_brushElm.height=200;_ctx=_brushElm.getContext("2d");AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"getCanvasControlsElement").append(_brushElm)};api.show=function(){if(!_brushElm)_createBrush();avpw$(_brushElm).fadeIn()};api.hide=function(){if(_brushElm)avpw$(_brushElm).hide()};api.setPosition=function(x,y){var zoomScale=AV.controlsWidgetInstance.canvasUI.viewport.getRatio();_brushElm.style.top=(y/zoomScale+.5|0)+"px";_brushElm.style.left=(x/zoomScale+.5|0)+"px"};api.setSize=function(radius){if(!_brushElm)return;_brushElm.width=_brushElm.width;radius=radius*1.3;var x=radius;var y=radius;_ctx.beginPath();_ctx.strokeStyle="#ffffff";_ctx.arc(x,y,radius,0,2*Math.PI,false);_ctx.closePath();_ctx.stroke();var lineWidth=2;var innerRadius=radius-lineWidth;if(innerRadius>0){_ctx.beginPath();_ctx.strokeStyle="#000000";_ctx.arc(x,y,innerRadius,0,2*Math.PI,false);_ctx.closePath();_ctx.stroke()}_brushElm.style.marginLeft=-radius+"px";_brushElm.style.marginTop=-radius+"px"};mediator.on("canvas:showBrushCursor",api.show);mediator.on("canvas:hideBrushCursor",api.hide);mediator.on("canvas:setBrushPosition",api.setPosition);mediator.on("canvas:setBrushSize",api.setSize);return api}();AV.PaintWidget=function(width,height,actions,modeManager,filterManager,overlayRegistry,imageBorderManager){this.imgElementClean=null;this.busy=false;this.moduleLoadedCallback={};this.canvasReadyCallback=avpw$.Deferred?new avpw$.Deferred:null;this.active=null;this.layers=[];this.dirtyRect={bbox:new AV.Bbox,dirty:false};this.canvas=document.createElement("canvas");this.setDimensions(width,height);this.canvas.id="avpw_canvas_element";this.dirty=false;this.actions=actions;if(modeManager&&modeManager.init){modeManager.init(this);this.modeManager=modeManager}this.filterManager=filterManager;this.overlayRegistry=overlayRegistry;this.imageBorderManager=imageBorderManager};AV.PaintWidget.prototype.setOrigSize=function(w,h){this._origWidth=w+.5|0;this._origHeight=h+.5|0};AV.PaintWidget.prototype.getOrigSize=function(){return{width:this._origWidth,height:this._origHeight}};AV.PaintWidget.prototype.c2a=function(w,h,forceFloor){var factor,newHiresWidth,newHiresHeight,currentDims=this.getScaledSize();if(currentDims.hiresWidth&&currentDims.hiresHeight){if(w!=currentDims.width||h!=currentDims.height){factor=currentDims.hiresWidth/currentDims.width;newHiresWidth=w*factor;if(forceFloor)newHiresWidth=newHiresWidth+.5|0;factor=currentDims.hiresHeight/currentDims.height;newHiresHeight=h*factor;if(forceFloor)newHiresHeight=newHiresHeight+.5|0;return{width:w,height:h,hiresWidth:newHiresWidth,hiresHeight:newHiresHeight}}else{return currentDims}}else{return{width:w,height:h}}};AV.PaintWidget.prototype.a2c=function(w,h,forceFloor){var factor,newWidth,newHeight,currentDims=this.getScaledSize();if(currentDims.hiresWidth&&currentDims.hiresHeight){if(w!=currentDims.width||h!=currentDims.height){factor=currentDims.width/currentDims.hiresWidth;newWidth=w*factor;if(forceFloor)newWidth=newWidth+.5|0;factor=currentDims.height/currentDims.hiresHeight;newHeight=h*factor;if(forceFloor)newHeight=newHeight+.5|0;return{width:newWidth,height:newHeight,hiresWidth:w,hiresHeight:h}}else{return currentDims}}else{return{width:w,height:h}}};AV.PaintWidget.prototype.setBackground=function(imgElementClean){var c,originClean;imgElementClean.crossOrigin="Anonymous";this.imgElementClean=imgElementClean;var bgcanvas=document.createElement("canvas");bgcanvas.width=this.width;bgcanvas.height=this.height;c=bgcanvas.getContext("2d");c.drawImage(imgElementClean,0,0,this.width,this.height);originClean=AV.cnvs.isOriginClean(c);this.addLayer(new AV.Layer({canvas:bgcanvas,name:"background"}));this.recomposite();this.currentLayerIndex=0;this.currentLayer=this.layers[this.currentLayerIndex];if(this.canvasReadyCallback){this.canvasReadyCallback.resolve()}return originClean};AV.PaintWidget.prototype.shutdown=function(){this.setMode(null);if(this.modeManager){this.modeManager.shutdown();this.modeManager=null}this.actions=null;this.layers=null;this.currentLayer=null;this.canvas=null;this.moduleLoadedCallback=null;this.canvasReadyCallback=null;this.waitThrobberShow=null};AV.PaintWidget.prototype.moduleLoaded=function(modulename,callback){var pw=this,dfd,asyncCodeDeferreds=[];var completeDeferred=function(){dfd.done(function(){if(callback){callback.apply(this,[modulename])}});pw.moduleLoadedCallback[modulename]=dfd};var buildAsyncCodeDeferreds=function(assets){var i,url;for(i=0;i<assets.length;i++){url=assets[i].resourceUrl;if(url){!function(){var codeLoad=new avpw$.Deferred;if(assets[i].assetType===AV.controlsWidgetInstance.assetManager.types.EFFECT){pw.filterManager.loadPack(assets[i].assetId,url,function(){codeLoad.resolve()})}else if(assets[i].assetType===AV.controlsWidgetInstance.assetManager.types.IMAGEBORDER){pw.imageBorderManager.loadPack(assets[i].assetId,url,codeLoad.resolve)}else if(assets[i].assetType===AV.controlsWidgetInstance.assetManager.types.FONTPACK){AV.util.loadFile(url,"js",codeLoad.resolve)}else{codeLoad.resolve()}asyncCodeDeferreds.push(codeLoad)}()}}asyncCodeDeferreds.push(pw.canvasReadyCallback);dfd=avpw$.when.apply(pw,asyncCodeDeferreds);completeDeferred()};if(pw.moduleLoadedCallback){dfd=pw.moduleLoadedCallback[modulename]}if(!dfd){if(modulename==="effects"){if(AV.controlsWidgetInstance.assetManager){AV.controlsWidgetInstance.assetManager.getAssets("EFFECT",buildAsyncCodeDeferreds)}}else if(modulename==="frames"){if(AV.controlsWidgetInstance.assetManager){AV.controlsWidgetInstance.assetManager.getAssets("IMAGEBORDER",buildAsyncCodeDeferreds)}}else if(modulename==="textwithfont"){if(AV.controlsWidgetInstance.assetManager){AV.controlsWidgetInstance.assetManager.getAssets("FONTPACK",buildAsyncCodeDeferreds)}}else{dfd=avpw$.when(pw.canvasReadyCallback);completeDeferred()}}else{completeDeferred()}return dfd?dfd.isResolved():false};AV.PaintWidget.prototype.setDimensions=function(w,h){this.canvas.width=this.width=w;this.canvas.height=this.height=h;if(AV.controlsWidgetInstance){if(AV.controlsWidgetInstance.canvasUI){AV.controlsWidgetInstance.canvasUI.resetOffset()}AV.controlsWidgetInstance.layoutNotify(AV.launchData["openType"],"scaleCanvas")}};AV.PaintWidget.prototype.getScaledSize=function(){if(this.actions){return this.actions.getDims()}else{return{width:this.width,height:this.height}}};AV.PaintWidget.prototype.showWaitThrobber=function(show,callback){if(callback){setTimeout(callback,5)}};AV.PaintWidget.prototype.getBackgroundLayerIndex=function(){return 0};AV.PaintWidget.prototype.findLayerIndexByName=function(name){var i;for(i=0;i<this.layers.length;i++){if(this.layers[i].name===name){return i}}return-1};AV.PaintWidget.prototype.getLayerByName=function(name){var i=this.findLayerIndexByName(name);if(i===-1){return null}return this.layers[i]};AV.PaintWidget.prototype.moveLayerByName=function(name,x,y){var l=this.getLayerByName(name);if(l===null){return}l.translateX=x;l.translateY=y};AV.PaintWidget.prototype.setCurrentLayerByName=function(name){var i=this.findLayerIndexByName(name);if(i===-1){return false}this.currentLayerIndex=i;this.currentLayer=this.layers[i];return true};AV.PaintWidget.prototype.layerToTop=function(index){var l=this.layers[index];while(index<this.layers.length-1){var t=parseInt(index,10)+1;this.layers[index]=this.layers[t];index++}this.layers[index]=l};AV.PaintWidget.prototype.layerDelete=function(index){while(index<this.layers.length-1){var t=parseInt(index,10)+1;this.layers[index]=this.layers[t];index++}this.layers.length-=1};AV.PaintWidget.prototype.uiLayerReset=function(){var i=this.findLayerIndexByName("_ui");if(i==-1){var newCanvas=document.createElement("canvas");newCanvas.width=this.canvas.width;newCanvas.height=this.canvas.height;var l=new AV.Layer({canvas:newCanvas,name:"_ui"});l.hidden=true;this.layers.push(l)}else{this.layers[i].hidden=true;this.layers[i].canvas.width=this.canvas.width;this.layers[i].canvas.height=this.canvas.height;this.layerToTop(i)}};AV.PaintWidget.prototype.uiLayerShow=function(show){var i=this.findLayerIndexByName("_ui");if(i!=-1){this.layers[i].hidden=!show;if(!show){this.recomposite()}}};AV.PaintWidget.prototype.uiLayerClear=function(){var l=this.getLayerByName("_ui");var c=l.canvas.getContext("2d");c.globalCompositeOperation="copy";c.clearRect(0,0,l.canvas.width,l.canvas.height);c.globalCompositeOperation="source-over"};AV.PaintWidget.prototype.uiLayerDrawCircleSelection=function(x,y,radius,noClear){var l=this.getLayerByName("_ui");var c=l.canvas.getContext("2d");var lineWidth=1;if(!noClear){c.globalCompositeOperation="copy";c.clearRect(0,0,l.canvas.width,l.canvas.height)}var zoomScale=1;if(AV.controlsWidgetInstance.canvasUI){zoomScale=AV.controlsWidgetInstance.canvasUI.viewport.getRatio()}lineWidth=lineWidth*zoomScale+.5|0;c.globalCompositeOperation="source-over";c.lineWidth=lineWidth;c.globalAlpha=1;c.beginPath();c.strokeStyle="#ffffff";c.arc(x,y,radius,0,2*Math.PI,false);c.closePath();c.stroke();var innerRadius=radius-lineWidth;if(innerRadius>0){c.beginPath();c.strokeStyle="#000000";c.arc(x,y,innerRadius,0,2*Math.PI,false);c.closePath();c.stroke()}};AV.PaintWidget.prototype.dirtyRectEnable=function(enable){this.dirtyRect.dirty=enable};AV.PaintWidget.prototype.recomposite=function(fromDepth){var i;var l;AV.cnvs.clearCanvas(this.canvas);var cc=this.canvas.getContext("2d");if(fromDepth==null){fromDepth=0}else{fromDepth--;if(fromDepth<0){fromDepth=0}}cc.setTransform(1,0,0,1,0,0);for(i=fromDepth;i<this.layers.length;i++){l=this.layers[i];if(l.hidden){continue}cc.save();if(this.dirtyRect.dirty){cc.beginPath();cc.rect(this.dirtyRect.bbox.x0,this.dirtyRect.bbox.y0,this.dirtyRect.bbox.w,this.dirtyRect.bbox.h);cc.clip();cc.closePath()}cc.translate(l.translateX,l.translateY);cc.rotate(l.rotate);cc.scale(l.scaleX,l.scaleY);if(l.centerX!=null&&l.centerY!=null){cc.translate(-l.centerX,-l.centerY)}if(l.alpha!=null){cc.globalAlpha=l.alpha}else{cc.globalAlpha=1}cc.drawImage(l.drawable,0,0);cc.restore()}if(this.debugPoint!=null){cc.setTransform(1,0,0,1,0,0);cc.strokeStyle="#00ffff";cc.lineWidth=1;cc.lineCap="round";cc.lineJoin="round";cc.strokeRect(this.debugPoint.x-2,this.debugPoint.y-2,4,4)}};AV.PaintWidget.prototype.makeThumbFlat=function(newCanvas,surround){this.recomposite();var w=newCanvas.width;var h=newCanvas.height;var ctx=newCanvas.getContext("2d");ctx.globalCompositeOperation="copy";ctx.clearRect(0,0,newCanvas.width,newCanvas.height);ctx.globalCompositeOperation="source-over";var wmult=w/this.canvas.width;var hmult=h/this.canvas.height;if(surround){if(wmult>hmult){var destW=this.canvas.width*hmult;var xpos=(w-destW)/2;ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,xpos,0,destW,h)}else{var destH=this.canvas.height*wmult;var ypos=(h-destH)/2;ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,ypos,w,destH)}}else{if(wmult<hmult){var destW=this.canvas.width*hmult;var xpos=-(destW-w)/2;ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,xpos,0,destW,h)}else{var destH=this.canvas.height*wmult;var ypos=-(destH-h)/2;ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,ypos,w,destH)}}return newCanvas};AV.PaintWidget.prototype.exportImage=function(mime,callback){mime=mime||"image/png";this.uiLayerShow(false);this.recomposite();var supportsToDataURL=function(){var c=document.createElement("canvas");var data=c.toDataURL("image/png");return data.indexOf("data:image/png")==0};var dataURL;if(supportsToDataURL()){dataURL=this.canvas.toDataURL(mime)}else{dataURL=AV.toBitmapURL(this.canvas)}if(callback&&typeof callback==="function"){callback.apply(this,[dataURL])}return true};AV.PaintWidget.prototype.addLayer=function(layer){this.layers.push(layer);return this.layers.length-1};AV.PaintWidget.prototype.setMode=function(mode){if(this.active!==null){if(this.active.deactivate!==undefined){this.active.deactivate()}}if(mode!==null&&mode!==undefined&&mode!==""){var newactive=this.module[mode];if(newactive!==undefined){this.active=newactive;if(this.active.activate!==undefined){this.active.activate(this)}}}else{this.active=null}};AV.PaintWidget.prototype.undo=function(){if(this.active&&this.active.userUndo!==undefined){this.active.userUndo()}this.actions.undo();if(this.active&&this.active.userPostUndo!==undefined){this.active.userPostUndo()}};AV.PaintWidget.prototype.redo=function(){if(this.active&&this.active.userRedo!==undefined){this.active.userRedo()}this.actions.redo();if(this.active&&this.active.userPostRedo!==undefined){this.active.userPostRedo()}};AV.PaintWidget.prototype.getBacking=function(x,y,w,h){var c=this.canvas.getContext("2d");var id=c.getImageData(x,y,w,h);return id};AV.PaintWidget.prototype.getBackingAll=function(){var c=this.canvas.getContext("2d");return c.getImageData(0,0,this.canvas.width,this.canvas.height)};AV.PaintWidget.prototype.putBacking=function(layer,backing,x,y){var c=layer.canvas.getContext("2d");c.putImageData(backing,x,y)};AV.PaintWidget.prototype.rotate90=function(){var i,c;var _rotateOverlay90=function(l,angle){var t;l.rotate+=angle*Math.PI/180;if(angle==90){t=l.translateX;l.translateX=this.canvas.width-l.translateY;l.translateY=t}else if(angle==270){t=l.translateX;l.translateX=l.translateY;l.translateY=this.canvas.height-t}else if(angle==180){l.translateX=this.canvas.width-l.translateX;l.translateY=this.canvas.height-l.translateY}};return function(angle){angle%=360;if(angle<0){angle+=360}angle=parseInt(angle/90,10)*90;if(angle==0){return}if(angle%180!=0){this.setDimensions(this.canvas.height,this.canvas.width)}var tx;var ty;for(i=0;i<this.layers.length;i++){var l=this.layers[i];if(l.canvas!=null){if(l.tag=="module_text"){_rotateOverlay90(l,angle)}else{var newCanvas=document.createElement("canvas");newCanvas.width=this.canvas.width;newCanvas.height=this.canvas.height;c=newCanvas.getContext("2d");c.setTransform(1,0,0,1,0,0);c.translate(newCanvas.width/2,newCanvas.height/2);c.rotate(angle*3.14159265358979/180);c.translate(-l.canvas.width/2,-l.canvas.height/2);c.globalCompositeOperation="copy";c.drawImage(l.canvas,0,0);c.globalCompositeOperation="source-over";c.setTransform(1,0,0,1,0,0);l.canvas=l.drawable=newCanvas}}else if(l.image!=null){_rotateOverlay90(l,angle)}}this.recomposite()}}();AV.PaintWidget.prototype._dupLayerAttrs=function(dest,src){if(src.hidden==true){dest.hidden=true}if(src.alpha!=undefined){dest.alpha=src.alpha}dest.rotate=src.rotate;dest.scaleX=src.scaleX;dest.scaleY=src.scaleY;dest.translateX=src.translateX;dest.translateY=src.translateY;if(src.centerX!=null){dest.centerX=src.centerX}if(src.centerY!=null){dest.centerY=src.centerY}if(src.tag!=null){dest.tag=src.tag}if(src.module_data!=null){dest.module_data=src.module_data}};AV.PaintWidget.prototype.duplicateAllLayers=function(){var newLayers=[];var i,l,c;for(i=0;i<this.layers.length;i++){if(this.layers[i].name=="_ui"){continue}if(this.layers[i].canvas!=null){var newCanvas=document.createElement("canvas");newCanvas.width=this.layers[i].canvas.width;newCanvas.height=this.layers[i].canvas.height;c=newCanvas.getContext("2d");c.drawImage(this.layers[i].canvas,0,0,newCanvas.width,newCanvas.height);l=new AV.Layer({canvas:newCanvas,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i]);newLayers.push(l)}else if(this.layers[i].image!=null){l=new AV.Layer({image:this.layers[i].image,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i]);newLayers.push(l)}}return newLayers};AV.PaintWidget.prototype.duplicateAllLayersFrom=function(src){var i,c;for(i=0;i<src.length;i++){if(src[i].name=="_ui"){continue}var existing=this.getLayerByName(src[i].name);if(existing===null){existing=new AV.Layer({name:src[i].name});this.layers.push(existing)}if(src[i].canvas!=null){if(existing.canvas==null){existing.canvas=document.createElement("canvas")}existing.drawable=existing.canvas;existing.canvas.width=src[i].canvas.width;existing.canvas.height=src[i].canvas.height;c=existing.canvas.getContext("2d");c.drawImage(src[i].canvas,0,0,src[i].canvas.width,src[i].canvas.height);this._dupLayerAttrs(existing,src[i])}else if(src[i].image!=null){existing.image=src[i].image;existing.drawable=existing.image;this._dupLayerAttrs(existing,src[i])}}};AV.PaintWidget.prototype.resizeAllLayers=function(width,height,rescaleImages){var i,c,l;var newLayers=[];var oldwidth=this.width,scale;this.setDimensions(width,height);for(i=0;i<this.layers.length;i++){if(this.layers[i].canvas!=null){var newCanvas=document.createElement("canvas");newCanvas.width=width;newCanvas.height=height;c=newCanvas.getContext("2d");c.drawImage(this.layers[i].canvas,0,0,width,height);l=new AV.Layer({canvas:newCanvas,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i])}else if(this.layers[i].image!=null){l=new AV.Layer({image:this.layers[i].image,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i])}if(l){if(rescaleImages&&(l.image||l.tag==="module_text")){scale=width/oldwidth;l.translateX*=scale;l.translateY*=scale;l.scaleX*=scale;l.scaleY*=scale}newLayers.push(l)}}this.layers=newLayers;this.recomposite()};AV.PaintWidget.prototype.resizeAllLayersQnD=function(width,height){var i;this.setDimensions(width,height);for(i=0;i<this.layers.length;i++){if(this.layers[i].canvas!=null){this.layers[i].canvas.width=width;this.layers[i].canvas.height=height}}};AV.PaintWidget.prototype.flattenAllLayers=function(){var uiLayer=this.getLayerByName("_ui");this.uiLayerShow(false);this.recomposite();this.layers.length=0;var newCanvas=document.createElement("canvas");newCanvas.width=this.canvas.width;newCanvas.height=this.canvas.height;var l=new AV.Layer({canvas:newCanvas,name:"background"});this.layers.push(l);if(uiLayer){this.layers.push(uiLayer)}var cc=newCanvas.getContext("2d");cc.drawImage(this.canvas,0,0)};AV.PaintWidget.prototype.cropAllLayers=function(x0,y0,width,height){var i,c,l,thislayer;var cropType;var newLayers=[];this.setDimensions(width,height);for(i=0;i<this.layers.length;i++){thislayer=this.layers[i];if(thislayer.canvas!=null){if(thislayer.tag=="module_text"){cropType="textcanvas"}else{cropType="canvas"}}else if(thislayer.image!=null){cropType="image"}else{continue}switch(cropType){case"canvas":var newCanvas=document.createElement("canvas");newCanvas.width=width;newCanvas.height=height;c=newCanvas.getContext("2d");c.drawImage(this.layers[i].canvas,-x0,-y0,this.layers[i].canvas.width,this.layers[i].canvas.height);l=new AV.Layer({canvas:newCanvas,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i]);newLayers.push(l);break;case"image":l=new AV.Layer({image:this.layers[i].image,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i]);l.translateX-=x0;l.translateY-=y0;newLayers.push(l);break;case"textcanvas":var newCanvas=document.createElement("canvas");c=newCanvas.getContext("2d");newCanvas.width=thislayer.canvas.width;newCanvas.height=thislayer.canvas.height;c.drawImage(this.layers[i].canvas,0,0);l=new AV.Layer({canvas:newCanvas,name:this.layers[i].name});this._dupLayerAttrs(l,this.layers[i]);l.translateX-=x0;l.translateY-=y0;newLayers.push(l);break}}this.layers=newLayers;this.recomposite()};AV.PaintWidget.prototype.module={};AV.PaintWidget.prototype.module["bulge"]=function(){var _paintWidget;var _radius=100;var _power=0;var api={};var _doDistort=function(dest,src,width,height,r,power){var r2=r*2;var rr=r*r;var distort;if(power>=0){distort=-power/120}else{distort=-power/200}var a=1-distort;var b=distort/r;var destIndex=0;for(var destY=0;destY<height;destY++){var deltaY=destY-r;var deltaYY=deltaY*deltaY;for(var destX=0;destX<width;destX++){var deltaX=destX-r;var deltaRR=deltaX*deltaX+deltaYY;if(deltaRR<rr){var deltaR=Math.sqrt(deltaRR);var scale=.999999/(a+b*deltaR);var srcX=deltaX*scale+r;var srcY=deltaY*scale+r;var iSrcX=srcX|0;var iSrcY=srcY|0;var hiFracX=srcX-iSrcX;var hiFracY=srcY-iSrcY;var loFracX=1-hiFracX;var loFracY=1-hiFracY;var srcIndex=(iSrcX+iSrcY*width)*4;var rTop=src[srcIndex]*loFracX+src[srcIndex+4]*hiFracX;var gTop=src[srcIndex+1]*loFracX+src[srcIndex+5]*hiFracX;var bTop=src[srcIndex+2]*loFracX+src[srcIndex+6]*hiFracX;var aTop=src[srcIndex+3]*loFracX+src[srcIndex+7]*hiFracX;srcIndex+=width*4;var rBot=src[srcIndex]*loFracX+src[srcIndex+4]*hiFracX;var gBot=src[srcIndex+1]*loFracX+src[srcIndex+5]*hiFracX;var bBot=src[srcIndex+2]*loFracX+src[srcIndex+6]*hiFracX;var aBot=src[srcIndex+3]*loFracX+src[srcIndex+7]*hiFracX;dest[destIndex++]=rTop*loFracY+rBot*hiFracY;dest[destIndex++]=gTop*loFracY+gBot*hiFracY;dest[destIndex++]=bTop*loFracY+bBot*hiFracY;dest[destIndex++]=aTop*loFracY+aBot*hiFracY}else{dest[destIndex]=src[destIndex];destIndex++;dest[destIndex]=src[destIndex];destIndex++;dest[destIndex]=src[destIndex];destIndex++;dest[destIndex]=src[destIndex];destIndex++}}}};var _getDistortedPixels=function(canvas,x,y,r,power){var width=r*2+1;var height=r*2+1;var pixels=AV.cnvs.getImageDataRegion(canvas,x-r,y-r,width,height,true);
var distorteds=canvas.getContext("2d").createImageData(width,height);_doDistort(distorteds.data,pixels.data,width,height,r,power);return distorteds};var _bulgeUndo=function(layerName,backing,x,y){var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,x,y);c.globalCompositeOperation="source-over";_paintWidget.recomposite()};var _bulgeRedo=function(layerName,x,y,r,power){var layer=_paintWidget.getLayerByName(layerName);var canvas=layer.canvas;var distorteds=_getDistortedPixels(canvas,x,y,r,power);AV.cnvs.putImageDataRegion(canvas,distorteds,x-r,y-r);_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget;_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true)};api.deactivate=function(){_paintWidget.uiLayerShow(false)};api.userUndo=function(){_paintWidget.uiLayerShow(false)};api.userRedo=function(){_paintWidget.uiLayerShow(false)};api.setRadius=function(r){_radius=r};api.setPower=function(p){_power=p};api.updateUI=function(x,y){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var canvas=layer.canvas;if(canvas==null){return}if(x<0||x>=canvas.width||y<0||y>=canvas.height){return}var r=_radius;var power=_power;var distorteds=_getDistortedPixels(canvas,x,y,r,power);_paintWidget.uiLayerShow(true);_paintWidget.uiLayerClear();AV.cnvs.putImageDataRegion(_paintWidget.getLayerByName("_ui").canvas,distorteds,x-r,y-r);_paintWidget.uiLayerDrawCircleSelection(x,y,r,true);_paintWidget.recomposite()};api.apply=function(x,y){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var canvas=layer.canvas;if(canvas==null){return}if(x<0||x>=canvas.width||y<0||y>=canvas.height){return}var x0=x-_radius;var y0=y-_radius;var wh=_radius*2+1;var backing=AV.cnvs.copyCanvas(canvas,x0,y0,wh,wh);_paintWidget.actions.push([_bulgeUndo,this,[layer.name,backing,x0,y0]],[_bulgeRedo,this,[layer.name,x,y,_radius,_power]],{action:"bulge",center:[x,y],radius:_radius,power:_power});_paintWidget.actions.redo();return _radius};return api}();AV.PaintWidget.prototype.module["flip"]=function(){var _paintWidget;var api={};var _flipRun=function(canvas,horizontal,vertical){var c=canvas.getContext("2d");var c2;if(horizontal){c2=AV.cnvs.copyCanvas(canvas);AV.cnvs.clearCanvas(canvas);c.setTransform(-1,0,0,1,canvas.width,0);c.drawImage(c2,0,0)}if(vertical){c2=AV.cnvs.copyCanvas(canvas);AV.cnvs.clearCanvas(canvas);c.setTransform(1,0,0,-1,0,canvas.height);c.drawImage(c2,0,0)}c.setTransform(1,0,0,1,0,0)};var _flipHV=function(horizontal,vertical,flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var oldLayers;if(layer.canvas==null){return}if(flatten){oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.actions.push([_flipUndo,this,[oldLayers]],[_flipRedo,this,[layer.name,horizontal,vertical,flatten]],{action:"flip",horizontal:horizontal,vertical:vertical,flatten:flatten})}else{_paintWidget.actions.push([_flipRedo,this,[layer.name,horizontal,vertical,flatten]],[_flipRedo,this,[layer.name,horizontal,vertical,flatten]],{action:"flip",horizontal:horizontal,vertical:vertical,flatten:flatten})}_paintWidget.actions.redo()};var _flipUndo=function(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _flipRedo=function(layerName,horizontal,vertical,flatten){if(flatten){_paintWidget.flattenAllLayers()}var layer=_paintWidget.getLayerByName(layerName);_flipRun(layer.canvas,horizontal,vertical);_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget};api.flip=function(horizontal,vertical,flatten){_flipHV(horizontal,vertical,flatten)};api.readAction=function(data,next){if(data&&(data.horizontal||data.vertical)){api.flip(data.horizontal,data.vertical,data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["desaturate"]=function(){var _paintWidget;var api={};var _desaturationRun=function(data){for(var i=0;i<data.length;i+=4){data[i]=data[i+1]=data[i+2]=(data[i]+data[i+1]+data[i+2])/3|0}};var _desaturateUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _desaturateRedo=function(layerName,flatten){if(flatten){_paintWidget.flattenAllLayers()}var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");var backing=c.getImageData(0,0,layer.canvas.width,layer.canvas.height);_paintWidget.showWaitThrobber(true,function(){_desaturationRun(backing.data);c.putImageData(backing,0,0);_paintWidget.recomposite();_paintWidget.showWaitThrobber(false)})};api.activate=function(paintWidget){_paintWidget=paintWidget};api.makeThumb=function(canvas){_paintWidget.makeThumbFlat(canvas);var cc=canvas.getContext("2d");var pixels=cc.getImageData(0,0,canvas.width,canvas.height);_desaturationRun(pixels.data);cc.putImageData(pixels,0,0)};api.desaturate=function(flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];if(layer.canvas==null){return}var backing=null;var oldLayers=null;if(flatten){oldLayers=_paintWidget.duplicateAllLayers()}else{backing=AV.cnvs.copyCanvas(layer.canvas)}_paintWidget.actions.push([_desaturateUndo,this,[layer.name,backing,oldLayers]],[_desaturateRedo,this,[layer.name,flatten]],{action:"desaturate",flatten:flatten});_paintWidget.actions.redo()};return api}();AV.PaintWidget.prototype.module["saturation"]=function(){var _paintWidget;var _satchange=0;var _origBacking,_origBackingPixels,_newCanvasData,_oldLayers,_flatten;var _dirty;var api={};var _saturationRun=function(dest,src,val){var i,r,g,b,rNew,gNew,bNew;var v=val;var R=.213*(1-v);var G=.715*(1-v);var B=.072*(1-v);for(i=0;4*i<src.length;i++){r=src[4*i];g=src[4*i+1];b=src[4*i+2];rNew=(R+v)*r+G*g+B*b+.5|0;gNew=R*r+(G+v)*g+B*b+.5|0;bNew=R*r+G*g+(B+v)*b+.5|0;r=rNew>255?255:rNew<0?0:rNew;g=gNew>255?255:gNew<0?0:gNew;b=bNew>255?255:bNew<0?0:bNew;dest[4*i]=r;dest[4*i+1]=g;dest[4*i+2]=b;dest[4*i+3]=src[4*i+3]}};var _saturation=function(layerName,val,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;var cc;cc=layer.canvas.getContext("2d");if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName);cc=layer.canvas.getContext("2d")}_origBackingPixels=AV.cnvs.getCanvasPixelData(layer.canvas);_origBacking=AV.cnvs.copyCanvas(layer.canvas);_newCanvasData=cc.createImageData(layer.canvas.width,layer.canvas.height)}_satchange=val;_flatten=flatten;_saturationRun(_newCanvasData.data,_origBackingPixels.data,val);cc.putImageData(_newCanvasData,0,0);_paintWidget.recomposite()};var _pushState=function(){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_saturationUndo,this,[layer.name,_origBacking,_oldLayers]],[_saturationRedo,this,[layer.name,_satchange,_flatten]],{action:"saturation",value:_satchange,flatten:_flatten});_paintWidget.actions.redoFake()};var _saturationUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _saturationRedo=function(layerName,val,flatten){_saturation(layerName,val,flatten);_origBacking=null;_oldLayers=null;_dirty=true};api.applyPreview=function(val,flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];AV.util.nextFrame(function(){if(!_dirty){_paintWidget.actions.undoFake()}else{_paintWidget.actions.undo();_dirty=false}_saturation(layer.name,val,flatten);_pushState()})};api.resetBacking=function(){_origBacking=null};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=_origBackingPixels=null;_newCanvasData=null;_oldLayers=null;_satchange=0;_flatten=false;_dirty=false};api.deactivate=function(){api.reset()};api.reset=function(){_origBacking=null;_origBackingPixels=null;_newCanvasData=null;_oldLayers=null};api.readAction=function(data,next){if(data&&data.value!==undefined){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_saturation(layer.name,data.value,data.flatten);_pushState()}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["brightness"]=function(){var _paintWidget;var _brightnessProcessor=null;var _contrastProcessor=null;var _origBacking,_oldLayers,_flatten;var _bri,_con;var _dirty;var api={};var _brightnessRun=function(dest,bri,con){_brightnessProcessor=_brightnessProcessor||AV.require("../../../src/js/processors/tools/brightness");_contrastProcessor=_contrastProcessor||AV.require("../../../src/js/processors/tools/contrast");if(bri!==0){if(_brightnessProcessor.brightness){_brightnessProcessor.brightness(dest,bri)}}else if(con!==0){if(_contrastProcessor.contrast){_contrastProcessor.contrast(dest,con)}}};var _brightness=function(layerName,bri,con,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName)}_origBacking=AV.cnvs.copyCanvas(layer.canvas)}var cc=layer.canvas.getContext("2d");var newPixels=AV.cnvs.getCanvasPixelData(_origBacking);_bri=bri;_con=con;_flatten=flatten;_brightnessRun(newPixels.data,bri,con);cc.putImageData(newPixels,0,0);_paintWidget.recomposite()};var _brightnessUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _brightnessRedo=function(layerName,bri,con,flatten){_brightness(layerName,bri,con,flatten);_origBacking=null;_oldLayers=null;_dirty=true};var _pushState=function(){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var actionName=_bri!==0?"brightness":"contrast";var value=_bri!==0?_bri:_con;_paintWidget.actions.push([_brightnessUndo,this,[layer.name,_origBacking,_oldLayers]],[_brightnessRedo,this,[layer.name,_bri,_con,_flatten]],{action:actionName,value:value,flatten:_flatten});_paintWidget.actions.redoFake()};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=null;_oldLayers=null;_bri=0;_con=0;_flatten=false;_dirty=false};api.deactivate=function(){api.reset();_brightnessProcessor=null;_contrastProcessor=null};api.applyPreview=function(bri,con,flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];AV.util.nextFrame(function(){if(!_dirty){_paintWidget.actions.undoFake()}else{_paintWidget.actions.undo();_dirty=false}_brightness(layer.name,bri,con,flatten);_pushState()})};api.resetBacking=function(){_origBacking=null};api.reset=function(){_origBacking=null;_oldLayers=null};api.readAction=function(data,next){if(data&&data.action&&data.value!==undefined){var bri=0,con=0;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];if(data.action=="brightness"){bri=data.value}else if(data.action=="contrast"){con=data.value}_brightness(layer.name,bri,con,data.flatten);_pushState()}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["contrast"]=AV.PaintWidget.prototype.module["brightness"];AV.PaintWidget.prototype.module["colors"]=function(){var _paintWidget;var _r=0,_g=0,_b=0,_origBacking,_oldLayers,_origBackingPixels,_newCanvasData,_flatten;var api={};var _calcmult=function(mult){mult+=100;mult=mult*.75+50;return mult/100};var _colorsUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _colorsRedo=function(layerName,r,g,b,flatten){_set(layerName,r,g,b,flatten);_origBacking=null;_oldLayers=null};var _set=function(layerName,r,g,b,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;var cc;var rmult,gmult,bmult;cc=layer.canvas.getContext("2d");if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName);cc=layer.canvas.getContext("2d")}_origBackingPixels=AV.cnvs.getCanvasPixelData(layer.canvas);_origBacking=AV.cnvs.copyCanvas(layer.canvas);_newCanvasData=cc.createImageData(layer.canvas.width,layer.canvas.height)}_r=r;_b=b;_g=g;_flatten=flatten;rmult=_calcmult(r);gmult=_calcmult(g);bmult=_calcmult(b);_paintWidget.showWaitThrobber(true,function(){for(i=0;i<_origBackingPixels.data.length;){_newCanvasData.data[i]=_origBackingPixels.data[i]*rmult|0;i++;_newCanvasData.data[i]=_origBackingPixels.data[i]*gmult|0;i++;_newCanvasData.data[i]=_origBackingPixels.data[i]*bmult|0;i++;_newCanvasData.data[i]=_origBackingPixels.data[i];i++}cc.putImageData(_newCanvasData,0,0);_paintWidget.recomposite();_paintWidget.showWaitThrobber(false)})};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=null;_newCanvasData=null;_oldLayers=null;_r=_g=_b=0;_flatten=false};api.deactivate=function(){api.reset()};api.set=function(r,g,b,flatten){_paintWidget.dirty=true;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_set(layer.name,r,g,b,flatten)};api.reset=function(){if(_oldLayers){_paintWidget.duplicateAllLayersFrom(_oldLayers);_paintWidget.recomposite()}else if(_origBacking){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(_origBacking,0,0);c.globalCompositeOperation="source-over";_paintWidget.recomposite()}_origBacking=null;_origBackingPixels=null;_newCanvasData=null;_oldLayers=null};api.commit=function(){if(_origBacking==null){return}var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_colorsUndo,this,[layer.name,_origBacking,_oldLayers]],[_colorsRedo,this,[layer.name,_r,_g,_b,_flatten]],{action:"colors",red:_r,green:_g,blue:_b,flatten:_flatten});_paintWidget.actions.redoFake();_origBacking=null;_origBackingPixels=null;_newCanvasData=null;_oldLayers=null};return api}();AV.PaintWidget.prototype.module["straighten"]=function(){var _paintWidget;var _bbox;var _lastBbox;var api={};var _drawSelection=function(angle){var x0,y0,x1,y1,w,h;var l=_paintWidget.getLayerByName("_ui");if(_bbox.x0<_bbox.x1){x0=_bbox.x0;x1=_bbox.x1}else{x0=_bbox.x1;x1=_bbox.x0}if(_bbox.y0<_bbox.y1){y0=_bbox.y0;y1=_bbox.y1}else{y0=_bbox.y1;y1=_bbox.y0}w=x1-x0;h=y1-y0;var c=l.canvas.getContext("2d");c.globalCompositeOperation="copy";c.clearRect(0,0,l.canvas.width,l.canvas.height);c.globalCompositeOperation="source-over";if(angle){var centerX=_paintWidget.width/2;var centerY=_paintWidget.height/2;c.translate(centerX,centerY);c.rotate(-angle);c.translate(-centerX,-centerY)}c.fillStyle="#000000";c.globalAlpha=.6;var overflow=l.canvas.width>l.canvas.height?l.canvas.width:l.canvas.height;overflow=.5*overflow|0;c.fillRect(-overflow,-overflow,x0+overflow,l.canvas.height+2*overflow);c.fillRect(x1,-overflow,l.canvas.width-x1+overflow,l.canvas.height+2*overflow);c.fillRect(x0,-overflow,x1-x0,y0+overflow);c.fillRect(x0,y1,x1-x0,l.canvas.height-y1+2*overflow)};var _straightenUndo=function(oldLayers,width,height){_paintWidget.setDimensions(width,height);_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _straightenRedo=function(angle,w,h,flatten){var i,c,l;var destCanvas;if(flatten){_paintWidget.flattenAllLayers()}if(angle){for(i=0;i<_paintWidget.layers.length;i++){l=_paintWidget.layers[i];if(l.canvas!=null){destCanvas=document.createElement("canvas");destCanvas.width=w;destCanvas.height=h;c=destCanvas.getContext("2d");c.setTransform(1,0,0,1,0,0);c.translate(w/2,h/2);c.rotate(angle);c.translate(-l.canvas.width/2,-l.canvas.height/2);c.globalCompositeOperation="copy";c.drawImage(l.canvas,0,0);c.globalCompositeOperation="source-over";l.canvas=l.drawable=destCanvas}}_paintWidget.cropAllLayers(0,0,w,h);_paintWidget.recomposite()}};var straightenRect=function(angle,angleInDegrees,w,h,flatten){var oldLayers=_paintWidget.duplicateAllLayers();var oldWidth=_paintWidget.width;var oldHeight=_paintWidget.height;_paintWidget.actions.push([_straightenUndo,api,[oldLayers,oldWidth,oldHeight]],[_straightenRedo,api,[angle,w,h,flatten]],[{action:"rotate",angle:angleInDegrees,width:w,height:h,flatten:flatten},{action:"setfeathereditsize",width:w,height:h}],_paintWidget.c2a(w,h,true));_paintWidget.actions.redo()};api.activate=function(paintWidget){_paintWidget=paintWidget;_bbox=new AV.Bbox;_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true)};api.deactivate=function(){_paintWidget.uiLayerShow(false);_bbox=null};api.reset=function(){_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true);_paintWidget.recomposite()};api.set=function(angle){var w=_paintWidget.width;var h=_paintWidget.height;var centerX=w/2;var centerY=h/2;var x0=0;var x1=w;var y0=0;var y1=h;_bbox.x0=x0;_bbox.x1=x1;_bbox.y0=y0;_bbox.y1=y1;if(angle){var i;var cosa=Math.cos(angle);var sina=Math.sin(angle);var cosa_rev=Math.cos(-angle);var sina_rev=Math.sin(-angle);var x00=centerX+cosa*(x0-centerX)+sina*(y0-centerY);var x01=centerX+cosa*(x0-centerX)+sina*(y1-centerY);var x10=centerX+cosa*(x1-centerX)+sina*(y0-centerY);var x11=centerX+cosa*(x1-centerX)+sina*(y1-centerY);var y00=centerY+sina*-(x0-centerX)+cosa*(y0-centerY);var y01=centerY+sina*-(x0-centerX)+cosa*(y1-centerY);var y10=centerY+sina*-(x1-centerX)+cosa*(y0-centerY);var y11=centerY+sina*-(x1-centerX)+cosa*(y1-centerY);var rectEdges=[[x00,y00,x10,y10],[x10,y10,x11,y11],[x11,y11,x01,y01],[x01,y01,x00,y00]];var testLine1=[0,0,w,h];var testLine2=[w,0,0,h];var intersections=[];var addIntersectionPoint=function(p){var pox=centerX+cosa_rev*(p.x-centerX)+sina_rev*(p.y-centerY);var poy=centerY+sina_rev*-(p.x-centerX)+cosa_rev*(p.y-centerY);pox=pox|0;poy=poy|0;if(_bbox.contains(pox,poy)){intersections.push({x:p.x,y:p.y})}};for(i=0;i<rectEdges.length;i++){var l=rectEdges[i];var p={};if(AV.math.lineSegmentIntersection(l[0],l[1],l[2],l[3],testLine1[0],testLine1[1],testLine1[2],testLine1[3],p)){addIntersectionPoint(p)}if(AV.math.lineSegmentIntersection(l[0],l[1],l[2],l[3],testLine2[0],testLine2[1],testLine2[2],testLine2[3],p)){addIntersectionPoint(p)}}for(i=0;i<intersections.length;i++){var p=intersections[i];if(p.y>centerY){if(p.y<_bbox.y1)_bbox.y1=p.y}else{if(p.y>_bbox.y0)_bbox.y0=p.y}if(p.x>centerX){if(p.x<_bbox.x1)_bbox.x1=p.x}else{if(p.x>_bbox.x0)_bbox.x0=p.x}}}_paintWidget.uiLayerReset();_paintWidget.uiLayerShow(true);_drawSelection(angle);_paintWidget.recomposite();_lastBbox=_bbox;var straightenedWidth=_bbox.x1-_bbox.x0;return straightenedWidth?_paintWidget.width/straightenedWidth:1};api.commit=function(angle,angleInDegrees,flatten){_lastBbox=_lastBbox||_bbox;var x0=_lastBbox.x0+.5|0;var y0=_lastBbox.y0+.5|0;var x1=_lastBbox.x1+.5|0;var y1=_lastBbox.y1+.5|0;var w=x1-x0;var h=y1-y0;straightenRect(angle,angleInDegrees,w,h,flatten);_paintWidget.uiLayerShow(false)};api.readAction=function(data,next){var angle,angleInDegrees;if(data&&data.angle&&data.width&&data.height){angleInDegrees=data.angle;angle=angleInDegrees*Math.PI/180;straightenRect(angle,angleInDegrees,data.width,data.height,data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["rotate90"]=function(){var _paintWidget;var api={};var _rotate90Undo=function(oldLayers,width,height){_paintWidget.setDimensions(width,height);_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _rotate90Redo=function(angle,flatten){if(flatten){_paintWidget.flattenAllLayers()}_paintWidget.rotate90(angle)};api.activate=function(paintWidget){_paintWidget=paintWidget},api.rotate90=function(a,flatten){var oldLayers;var width;var height;var wh=_paintWidget.getScaledSize();var swappedWH=null;if(wh){swappedWH={width:wh.height,height:wh.width,hiresWidth:wh.hiresHeight,hiresHeight:wh.hiresWidth}}if(flatten){oldLayers=_paintWidget.duplicateAllLayers();width=_paintWidget.width;height=_paintWidget.height;_paintWidget.actions.push([_rotate90Undo,this,[oldLayers,width,height]],[_rotate90Redo,this,[a,flatten]],{action:"rotate90",angle:a,flatten:flatten},swappedWH)}else{_paintWidget.actions.push([_rotate90Redo,this,[-a,flatten]],[_rotate90Redo,this,[a,flatten]],{action:"rotate90",angle:a,flatten:flatten},swappedWH)}_paintWidget.actions.redo()};api.readAction=function(data,next){if(data&&data.angle){api.rotate90(data.angle,data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["resize"]=function(){var _paintWidget;var api={};var _resizeUndo=function(oldLayers,oldWidth,oldHeight){_paintWidget.setDimensions(oldWidth,oldHeight);_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _resizeRedo=function(width,height){_paintWidget.resizeAllLayers(width,height,true);_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget};api.resize=function(width,height,flatten){var oldLayers=_paintWidget.duplicateAllLayers(),localDims,oldWidth,oldHeight;if(flatten){_paintWidget.flattenAllLayers()}width=width+.5|0;height=height+.5|0;if(AV.controlsWidgetInstance){localDims=AV.controlsWidgetInstance.getScaledDims(width,height)}else{localDims={width:width,height:height}}oldWidth=_paintWidget.canvas.width;oldHeight=_paintWidget.canvas.height;_paintWidget.actions.push([_resizeUndo,this,[oldLayers,oldWidth,oldHeight]],[_resizeRedo,this,[localDims.width,localDims.height]],[{action:"resize",size:[width,height]},{action:"setfeathereditsize",width:localDims.width,height:localDims.height}],_paintWidget.a2c(width,height,true));_paintWidget.actions.redo()};api.readAction=function(data,next){if(data&&data.size&&data.size.length){api.resize(data.size[0],data.size[1],data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["crop"]=function(){var _paintWidget;var api={};var _cropUndo=function(oldLayers,oldWidth,oldHeight){_paintWidget.setDimensions(oldWidth,oldHeight);_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _cropRedo=function(x,y,w,h){_paintWidget.cropAllLayers(x,y,w,h);_paintWidget.recomposite()};var cropRect=function(x,y,w,h){var oldLayers=_paintWidget.duplicateAllLayers();var oldWidth=_paintWidget.canvas.width;var oldHeight=_paintWidget.canvas.height;var cropAction={action:"crop",upperleftpoint:[x,y],size:[w,h]};_paintWidget.actions.push([_cropUndo,api,[oldLayers,oldWidth,oldHeight]],[_cropRedo,api,[x,y,w,h]],[cropAction,{action:"setfeathereditsize",width:w,height:h}],_paintWidget.c2a(w,h,true));_paintWidget.actions.redo()};api.activate=function(paintWidget){_paintWidget=paintWidget};api.crop=function(bbox){bbox=bbox||new AV.Bbox;_paintWidget.uiLayerShow(false);var x0,y0,x1,y1,w,h;if(bbox.x0<bbox.x1){x0=bbox.x0;x1=bbox.x1}else{x0=bbox.x1;x1=bbox.x0}if(bbox.y0<bbox.y1){y0=bbox.y0;y1=bbox.y1}else{y0=bbox.y1;y1=bbox.y0}var l=_paintWidget.getLayerByName("_ui");if(x0<0){x0=0}if(y0<0){y0=0}if(x1>l.canvas.width){x1=l.canvas.width}if(y1>l.canvas.height){y1=l.canvas.height}w=x1-x0;h=y1-y0;cropRect(x0,y0,w,h)};api.readAction=function(data,next){if(data&&data.size&&data.upperleftpoint){cropRect(data.upperleftpoint[0],data.upperleftpoint[1],data.size[0],data.size[1])}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["overlay"]=function(){var _paintWidget;var api={};var _hideOverlay=function(name){var i=_paintWidget.findLayerIndexByName(name);if(i!=-1){_paintWidget.layerDelete(i)}_paintWidget.recomposite()};var _showOverlay=function(name,element,tx,ty,sx,sy,rot){var l=new AV.Layer({name:name,image:element});l.tag="module_overlay";l.centerX=l.drawable.width/2+.5|0;l.centerY=l.drawable.height/2+.5|0;if(rot!=null){l.translateX=tx;l.translateY=ty;l.rotate=rot;l.scaleX=sx;l.scaleY=sy}else{l.translateX=_paintWidget.width/2+.5|0;l.translateY=_paintWidget.height/2+.5|0}_paintWidget.layers.push(l);_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget};api.addOverlay=function(name,url,x,y,sx,sy,rot){var randId;if(!name){randId=Math.floor(Math.random()*4294967295).toString(16);name="_module_overlay-"+randId}var element=_paintWidget.overlayRegistry.getElement(url);var hiresurl=_paintWidget.overlayRegistry.getHiRes(url);var args=[name,element,x,y,sx,sy,rot];_paintWidget.actions.push([_hideOverlay,this,[name]],[_showOverlay,this,args],{action:"addsticker",url:hiresurl||url,id:name,center:[x,y],scale:[sx,sy],rotation:rot,external:hiresurl?1:0,size:[element.width,element.height],urls:[url,hiresurl]});_paintWidget.actions.redo();return name};api.readAction=function(data,next){var url,hiresurl,x,y,scaleX,scaleY;if(data&&data.url){if(data.center&&data.center.length){x=data.center[0];y=data.center[1]}if(data.scale&&data.scale.length){scaleX=data.scale[0];scaleY=data.scale[1]}if(data.urls&&data.urls.length){url=data.urls[0];hiresurl=data.urls[1]}else{url=data.url;hiresurl=data.url}_paintWidget.overlayRegistry.add(url,hiresurl);_paintWidget.overlayRegistry.getElement(url,function(){api.addOverlay("",url,x,y,scaleX,scaleY,data.rotation);if(next){next.call(this)}})}else{if(next){next.call(this)}}};return api}();AV.PaintWidget.prototype.module["effects"]=function(){var _paintWidget;var _proclistManager=null;var _filterCancelled=false;var _origBacking,_oldLayers;var _dirty;var api={};var _filter=function(layerName,id,filterParams,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}if(!_origBacking){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName)}_origBacking=AV.cnvs.copyCanvas(layer.canvas)}var canvas=layer.canvas;var cc=canvas.getContext("2d");var origBackingPixels=AV.cnvs.getCanvasPixelData(_origBacking);var newPixels=AV.cnvs.getCanvasPixelData(_origBacking);_proclistManager=_proclistManager||AV.require("./MoaLiteProclistManager");_proclistManager.MLPLRunEffect(_paintWidget.filterManager.getEffectById(id),newPixels,filterParams);cc.putImageData(newPixels,0,0);_paintWidget.recomposite()};var _pushState=function(filterData){var hiResData,effect;if(filterData){effect=_paintWidget.filterManager.getEffectById(filterData.filterName);hiResData={action:"effects",jsonstring:AV.JSON.stringify(effect),name:filterData.filterName,flatten:filterData.flatten};hiResData=AV.util?AV.util.extend(hiResData,filterData.filterParams):hiResData;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_filterUndo,this,[layer.name,_origBacking,_oldLayers]],[_filterRedo,this,[layer.name,filterData.filterName,filterData.filterParams,filterData.flatten]],hiResData);_paintWidget.actions.redoFake()}};var _filterUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _filterRedo=function(layerName,filterName,filterParams,flatten){_filter(layerName,filterName,filterParams,flatten);_origBacking=null;_oldLayers=null;_dirty=true};api.activate=function(paintWidget){_filterCancelled=false;_paintWidget=paintWidget;_dirty=false};api.deactivate=function(){if(_paintWidget.busy){_filterCancelled=true;_paintWidget.actions.undoFake();_paintWidget.busy=false}_origBacking=null;_oldLayers=null;_proclistManager=null};api.makeThumb=function(id,canvas){_paintWidget.makeThumbFlat(canvas);var width=canvas.width;var height=canvas.height;var cc=canvas.getContext("2d");var pixels=cc.getImageData(0,0,width,height);_proclistManager=_proclistManager||AV.require("./MoaLiteProclistManager");var effect=_paintWidget.filterManager.getEffectById(id);if(effect){_proclistManager.MLPLRunEffect(effect,pixels)}cc.putImageData(pixels,0,0)};api.applyPreview=function(id,filterParams,flatten){if(!_dirty){_paintWidget.actions.undoFake()}else{_paintWidget.actions.undo();_dirty=false}_paintWidget.dirty=true;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];if(layer.canvas==null){return}_filter(layer.name,id,filterParams,flatten);_pushState({filterName:id,filterParams:filterParams,flatten:flatten})};api.readAction=function(data,next){if(data&&data.name){api.applyPreview(data.name,data,data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["enhance"]=function(){var _paintWidget;var _processor=null;var _filterCancelled=false;var _origBacking,_oldLayers;var _dirty;var api={};var _filter=function(layerName,id,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}if(!_origBacking){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName)}_origBacking=AV.cnvs.copyCanvas(layer.canvas)}var canvas=layer.canvas;var cc=canvas.getContext("2d");var newPixels=AV.cnvs.getCanvasPixelData(_origBacking);_processor=_processor||AV.require("../../../src/js/processors/tools/enhance");if(_processor[id]){_processor[id](newPixels.data,canvas.width,canvas.height)}cc.putImageData(newPixels,0,0);_paintWidget.recomposite()};var _pushState=function(id,flatten){var hiResData={action:"effects",name:id,flatten:flatten};var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_filterUndo,this,[layer.name,_origBacking,_oldLayers]],[_filterRedo,this,[layer.name,id,flatten]],hiResData);_paintWidget.actions.redoFake()};var _filterUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _filterRedo=function(layerName,filterName,filterParams,flatten){_filter(layerName,filterName,filterParams,flatten);_origBacking=null;_oldLayers=null;_dirty=true};api.activate=function(paintWidget){_filterCancelled=false;_paintWidget=paintWidget;_dirty=false};api.deactivate=function(){if(_paintWidget.busy){_filterCancelled=true;_paintWidget.actions.undoFake();_paintWidget.busy=false}_origBacking=null;_oldLayers=null;_processor=null};api.applyPreview=function(id,flatten){if(!_dirty){_paintWidget.actions.undoFake()}else{_paintWidget.actions.undo();_dirty=false}_paintWidget.dirty=true;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];if(layer.canvas==null){return}_filter(layer.name,id,flatten);_pushState(id,flatten)};api.readAction=function(data,next){if(data&&data.id){api.applyPreview(data.id,data.flatten)}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["flatten"]=function(){var _paintWidget;var api={};var _flattenUndo=function(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers);_paintWidget.recomposite()};var _flattenRedo=function(width,height){_paintWidget.flattenAllLayers();_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget
};api.flatten=function(){var oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.actions.push([_flattenUndo,this,[oldLayers]],[_flattenRedo,this,[]],{action:"flatten"},null,{implicit:true});_paintWidget.actions.redo()};return api}();AV.PaintWidget.prototype.module["textwithfont"]=function(){var _TEXT_OUTLINE_FRACTION=1/12;var _paintWidget;var _outlineColor;var api={};var _textWidth=function(str,fontInfo){var lines=str.split("\n");var cc=_paintWidget.canvas.getContext("2d");var oldFont=cc.font;cc.font=fontInfo;var longest=0;var tm;var i;var pad=cc.measureText("W").width;for(i=0;i<lines.length;i++){tm=cc.measureText(lines[i]);var w=tm.width;if(w>longest){longest=w}}cc.font=oldFont;return longest+pad};var _textHeight=function(str,lineHeightPx){var lines=str.split("\n");return lineHeightPx*lines.length};var _textUndo=function(layername){var i=_paintWidget.findLayerIndexByName(layername);if(i>=0){_paintWidget.layerDelete(i);_paintWidget.recomposite()}};var _textRedo=function(name,str,fontName,fontStyle,fontSizePx,lineHeightPx,fontColor,outlineColor,opacity,x,y,rot){var fontInfo=(fontStyle?fontStyle+" ":"")+fontSizePx+"px "+fontName;var w=_textWidth(str,fontInfo);var h=_textHeight(str,lineHeightPx);var shadowWidth;opacity=opacity||1;var newCanvas=document.createElement("canvas");newCanvas.width=w;var drawPadding=fontSizePx;newCanvas.height=h+drawPadding*2;var l=new AV.Layer({canvas:newCanvas,name:name});l.tag="module_text";l.centerX=l.drawable.width/2+.5|0;l.centerY=l.drawable.height/2+.5|0;if(rot==null){l.rotate=0}else{l.rotate=rot}l.scaleX=1;l.scaleY=1;if(x==null){l.translateX=_paintWidget.width/2+.5|0;l.translateY=_paintWidget.height/2+.5|0}else{l.translateX=x;l.translateY=y}l.alpha=opacity;_paintWidget.layers.push(l);var cc=newCanvas.getContext("2d");cc.font=fontInfo;cc.textAlign="center";cc.textBaseline="bottom";cc.fillStyle=fontColor;cc.globalAlpha=1;var xpos=l.canvas.width/2+.5|0;var ypos=lineHeightPx+drawPadding;var lines=str.split("\n");var i;for(i=0;i<lines.length;i++){if(outlineColor){cc.strokeStyle=outlineColor;cc.lineWidth=fontSizePx*_TEXT_OUTLINE_FRACTION;cc.strokeText(lines[i],xpos,ypos)}cc.fillText(lines[i],xpos,ypos);ypos+=lineHeightPx}_paintWidget.recomposite()};api.activate=function(paintWidget){_paintWidget=paintWidget};api.deactivate=function(){};api.newText=function(str,font,fontSizePx,lineHeight,fontColor,outlineColor,opacity,x,y,rot){if(str==""){return}opacity=opacity||1;var randId=Math.floor(Math.random()*4294967295).toString(16);var name="_module_text-"+randId;if(!rot){rot=0}if(!x){x=_paintWidget.width/2+.5|0;y=_paintWidget.height/2+.5|0}var args;args=[name,str,font.value,font.style,fontSizePx,lineHeight,fontColor,outlineColor,opacity,x,y,rot];_paintWidget.actions.push([_textUndo,this,[name]],[_textRedo,this,args],{action:"addtext",id:name,text:str,font:font.label,size:fontSizePx,align:"center",color:AV.util.color_to_rgb(fontColor),outlinecolor:outlineColor?AV.util.color_to_rgb(outlineColor):undefined,center:[x,y],scale:[1,1],intensity:opacity,rotation:rot});_paintWidget.actions.redo();_paintWidget.recomposite()};api.readAction=function(data,next){var font,i,len,fonts;if(data&&data.text&&data.font&&AV.toolDefaults.textwithfont.presetsFont&&AV.util.addFontToPage&&AV.WebFont){fonts=AV.toolDefaults.textwithfont.presetsFont;len=fonts.length;for(i=0;i<len;i++){if(fonts[i].label===data.font){font=fonts[i];break}}AV.util.addFontToPage(font,function(font){var x,y,scaleX,scaleY;if(font){if(data.center&&data.center.length){x=data.center[0];y=data.center[1]}api.newText(data.text,font,data.size,data.size,data.color,data.outlinecolor,data.intensity,x,y,data.rotation)}if(next){next.call(this)}})}else if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["barrel"]=function(){var _paintWidget;var _origBacking,_origBackingPixels,_oldLayers,_flatten;var _newCanvasData;var _barrelchange=0;var api={};var _barrelRun=function(dest,src,width,height,val){if(val==0){var i;for(i=0;i<src.length;i++){dest[i]=src[i]}return}var centerX=(width-1)/2;var centerY=(height-1)/2;var extentX=centerX;var extentY=centerY;var cornerR2=extentX*extentX+extentY*extentY;var cornerR=Math.sqrt(cornerR2);var srcExtent;if(val>0){var degree=Math.pow(val/100,2)*8;srcExtent=cornerR}else{var degree=-Math.sqrt(-val/100)*.34;srcExtent=Math.min(extentY,extentX)}var dstExtent=AV.math.lowestPositiveQuadratic(degree/cornerR,1,-srcExtent);var scale=dstExtent/srcExtent*.999999;var destX;var destY;for(destY=0;destY<height;destY++){var destDy=scale*(destY-centerY);for(destX=0;destX<width;destX++){var destDx=scale*(destX-centerX);var destR2=destDx*destDx+destDy*destDy;var ratio=1+degree*Math.sqrt(destR2)/cornerR;var srcX=destDx*ratio+centerX;var srcY=destDy*ratio+centerY;var iSrcX=srcX|0;var iSrcY=srcY|0;var hiFracX=srcX-iSrcX;var hiFracY=srcY-iSrcY;var loFracX=1-hiFracX;var loFracY=1-hiFracY;var srcIndex=(iSrcX+iSrcY*width)*4;var rTop=src[srcIndex]*loFracX+src[srcIndex+4]*hiFracX;var gTop=src[srcIndex+1]*loFracX+src[srcIndex+5]*hiFracX;var bTop=src[srcIndex+2]*loFracX+src[srcIndex+6]*hiFracX;var aTop=src[srcIndex+3]*loFracX+src[srcIndex+7]*hiFracX;srcIndex+=width*4;var rBot=src[srcIndex]*loFracX+src[srcIndex+4]*hiFracX;var gBot=src[srcIndex+1]*loFracX+src[srcIndex+5]*hiFracX;var bBot=src[srcIndex+2]*loFracX+src[srcIndex+6]*hiFracX;var aBot=src[srcIndex+3]*loFracX+src[srcIndex+7]*hiFracX;var destIndex=(destX+destY*width)*4;dest[destIndex]=rTop*loFracY+rBot*hiFracY;dest[destIndex+1]=gTop*loFracY+gBot*hiFracY;dest[destIndex+2]=bTop*loFracY+bBot*hiFracY;dest[destIndex+3]=aTop*loFracY+aBot*hiFracY}}};var _barrel=function(layerName,val,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;var cc;cc=layer.canvas.getContext("2d");if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName);cc=layer.canvas.getContext("2d")}_origBackingPixels=AV.cnvs.getCanvasPixelData(layer.canvas);_origBacking=AV.cnvs.copyCanvas(layer.canvas);_newCanvasData=cc.createImageData(layer.canvas.width,layer.canvas.height)}_barrelchange=val;_flatten=flatten;_paintWidget.showWaitThrobber(true,function(){_barrelRun(_newCanvasData.data,_origBackingPixels.data,_origBackingPixels.width,_origBackingPixels.height,val);cc.putImageData(_newCanvasData,0,0);_paintWidget.recomposite();_paintWidget.showWaitThrobber(false)})};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=null;_newCanvasData=null;_oldLayers=null;_barrelchange=0;_flatten=false};var _barrelUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _barrelRedo=function(layerName,val,flatten){_barrel(layerName,val,flatten);_origBacking=null;_oldLayers=null};api.deactivate=function(){api.reset()};api.set=function(val,flatten){_paintWidget.dirty=true;var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_barrel(layer.name,val,flatten)};api.makeThumb=function(canvas,val){_paintWidget.makeThumbFlat(canvas);var cc=canvas.getContext("2d");var pixels=cc.getImageData(0,0,canvas.width,canvas.height);var newPixels=cc.createImageData(canvas.width,canvas.height);_barrelRun(newPixels.data,pixels.data,pixels.width,pixels.height,val);cc.putImageData(newPixels,0,0)};api.reset=function(){if(_oldLayers){_paintWidget.duplicateAllLayersFrom(_oldLayers);_paintWidget.recomposite()}else if(_origBacking){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(_origBacking,0,0);c.globalCompositeOperation="source-over";_paintWidget.recomposite()}_origBacking=null;_origBackingPixels=null;_newCanvasData=null;_oldLayers=null};api.commit=function(){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_barrelUndo,this,[layer.name,_origBacking,_oldLayers]],[_barrelRedo,this,[layer.name,_barrelchange,_flatten]],{action:"barrel",value:_barrelchange,flatten:_flatten});_paintWidget.actions.redoFake();_origBacking=null;_origBackingPixels=null;_newCanvasData=null;_oldLayers=null};return api}();AV.PaintWidget.prototype.module["sharpen"]=function(){var _paintWidget;var _origBacking,_oldLayers,_flatten;var _processor=null;var _sharpenchange=0;var api={};var _sharpenRun=function(dest,width,height,val){_processor=_processor||AV.require("../../../src/js/processors/sharpness");if(_processor.sharpen){_processor.sharpen(dest,width,height,val,1,"normal")}};var _sharpen=function(layerName,val,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;var cc;if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName)}_origBacking=AV.cnvs.copyCanvas(layer.canvas)}cc=layer.canvas.getContext("2d");var newPixels=AV.cnvs.getCanvasPixelData(layer.canvas);_sharpenchange=val;_flatten=flatten;_sharpenRun(newPixels.data,layer.canvas.width,layer.canvas.height,val);cc.putImageData(newPixels,0,0);_paintWidget.recomposite()};var _pushState=function(){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_sharpenUndo,this,[layer.name,_origBacking,_oldLayers]],[_sharpenRedo,this,[layer.name,_sharpenchange,_flatten]],{action:"tools",toolname:"sharpness",value:_sharpenchange});_paintWidget.actions.redoFake()};var _sharpenUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _sharpenRedo=function(layerName,val,flatten){_sharpen(layerName,val,flatten);_origBacking=null;_oldLayers=null};api.resetBacking=function(){_origBacking=null};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=null;_newCanvasData=null;_oldLayers=null;_sharpenchange=0;_flatten=false};api.deactivate=function(){_origBacking=null;_newCanvasData=null;_oldLayers=null;_processor=null};api.applyPreview=function(val,flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.showWaitThrobber(true,function(){_paintWidget.actions.undo();_sharpen(layer.name,val,flatten);_paintWidget.showWaitThrobber(false);_pushState()})};api.reset=function(){if(_oldLayers){_paintWidget.duplicateAllLayersFrom(_oldLayers);_paintWidget.recomposite()}else if(_origBacking){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(_origBacking,0,0);c.globalCompositeOperation="source-over";_paintWidget.recomposite()}_origBacking=null;_newCanvasData=null;_oldLayers=null};api.readAction=function(data,next){if(data&&data.value!==undefined){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_sharpen(layer.name,data.value,data.flatten);_paintWidget.showWaitThrobber(false);_pushState()}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["warmth"]=function(){var _paintWidget;var _processor=null;var _origBacking,_oldLayers,_flatten;var _warmthChange=0;var _dirty;var api={};var _warmth=function(layerName,val,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}var i;var cc;if(_origBacking==null){if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.getLayerByName(layerName)}_origBacking=AV.cnvs.copyCanvas(layer.canvas)}var cc=layer.canvas.getContext("2d");var newPixels=AV.cnvs.getCanvasPixelData(_origBacking);_warmthChange=val;_flatten=flatten;_processor=_processor||AV.require("../../../src/js/processors/tools/colortemp");if(_processor.colortemp){_processor.colortemp(newPixels.data,_warmthChange)}cc.putImageData(newPixels,0,0);_paintWidget.recomposite()};var _warmthUndo=function(layerName,backing,oldLayers){if(oldLayers){_paintWidget.duplicateAllLayersFrom(oldLayers)}else{var layer=_paintWidget.getLayerByName(layerName);var c=layer.canvas.getContext("2d");c.globalCompositeOperation="copy";c.drawImage(backing,0,0);c.globalCompositeOperation="source-over"}_paintWidget.recomposite()};var _warmthRedo=function(layerName,val,flatten){_warmth(layerName,val,flatten);_origBacking=null;_oldLayers=null;_dirty=true};var _pushState=function(){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_paintWidget.actions.push([_warmthUndo,this,[layer.name,_origBacking,_oldLayers]],[_warmthRedo,this,[layer.name,_warmthChange,_flatten]],{action:"colortemp",value:_warmthChange,flatten:_flatten});_paintWidget.actions.redoFake()};api.activate=function(paintWidget){_paintWidget=paintWidget;_origBacking=null;_oldLayers=null;_warmthChange=0;_flatten=false;_dirty=false};api.deactivate=function(){api.reset();_processor=null};api.applyPreview=function(val,flatten){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];AV.util.nextFrame(function(){if(!_dirty){_paintWidget.actions.undoFake()}else{_paintWidget.actions.undo();_dirty=false}_warmth(layer.name,val,flatten);_pushState()})};api.resetBacking=function(){_origBacking=null};api.reset=function(){_origBacking=null;_oldLayers=null};api.readAction=function(data,next){if(data&&data.value!==undefined){var layerIndex=_paintWidget.currentLayerIndex;var layer=_paintWidget.layers[layerIndex];_warmth(layer.name,data.value,data.flatten);_pushState()}if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["frames"]=function(){var _paintWidget;var _layerName;var _dirty;var api={};var _tileBorderApply=function(canvas,tiles,borderSize){var context=canvas.getContext("2d");var w=canvas.width;var h=canvas.height;var i;var xPosLastEnd,yPosLastEnd;var xPos,yPos;var goalPos,drawHeight,drawWidth;var avgBorderWidth=(tiles.l.w+tiles.t.h+tiles.r.w+tiles.b.h)/4;var leftWidth=borderSize*Math.min(w,h)*(tiles.l.w/avgBorderWidth);var rightWidth=borderSize*Math.min(w,h)*(tiles.r.w/avgBorderWidth);var topHeight=borderSize*Math.min(w,h)*(tiles.t.h/avgBorderWidth);var bottomHeight=borderSize*Math.min(w,h)*(tiles.b.h/avgBorderWidth);var leftHeight=leftWidth*(tiles.l.h/tiles.l.w);var rightHeight=rightWidth*(tiles.r.h/tiles.r.w);var topWidth=topHeight*(tiles.t.w/tiles.t.h);var bottomWidth=bottomHeight*(tiles.b.w/tiles.b.h);var leftWidthRound=Math.round(leftWidth);var rightWidthRound=Math.round(rightWidth);var topHeightRound=Math.round(topHeight);var bottomHeightRound=Math.round(bottomHeight);var nLeft=Math.max(1,Math.round((h-topHeight-bottomHeight)/leftHeight));var nRight=Math.max(1,Math.round((h-topHeight-bottomHeight)/rightHeight));var nTop=Math.max(1,Math.round((w-leftWidth-rightWidth)/topWidth));var nBottom=Math.max(1,Math.round((w-leftWidth-rightWidth)/bottomWidth));var leftHeight=(h-topHeight-bottomHeight)/nLeft;var rightHeight=(h-topHeight-bottomHeight)/nRight;var topWidth=(w-leftWidth-rightWidth)/nTop;var bottomWidth=(w-leftWidth-rightWidth)/nBottom;context.setTransform(leftWidthRound/tiles.tl.w,0,0,topHeightRound/tiles.tl.h,0,0);context.drawImage(tiles.tl.img,0,0);context.setTransform(rightWidthRound/tiles.tr.w,0,0,topHeightRound/tiles.tr.h,w-rightWidthRound,0);context.drawImage(tiles.tr.img,0,0);context.setTransform(rightWidthRound/tiles.br.w,0,0,bottomHeightRound/tiles.br.h,w-rightWidthRound,h-bottomHeightRound);context.drawImage(tiles.br.img,0,0);context.setTransform(leftWidthRound/tiles.bl.w,0,0,bottomHeightRound/tiles.bl.h,0,h-bottomHeightRound);context.drawImage(tiles.bl.img,0,0);yPosLastEnd=topHeightRound;xPos=0;for(i=0;i<nLeft;i++){goalPos=topHeight+i*leftHeight;yPos=yPosLastEnd;drawHeight=Math.round(goalPos-yPos+leftHeight);context.setTransform(leftWidthRound/tiles.l.w,0,0,drawHeight/tiles.l.h,xPos,yPos);context.drawImage(tiles.l.img,0,0);yPosLastEnd=yPos+drawHeight}xPosLastEnd=leftWidthRound;yPos=0;for(i=0;i<nTop;i++){goalPos=leftWidth+i*topWidth;xPos=xPosLastEnd;drawWidth=Math.round(goalPos-xPos+topWidth);context.setTransform(drawWidth/tiles.t.w,0,0,topHeightRound/tiles.t.h,xPos,yPos);context.drawImage(tiles.t.img,0,0);xPosLastEnd=xPos+drawWidth}yPosLastEnd=topHeightRound;xPos=w-rightWidthRound;for(i=0;i<nRight;i++){goalPos=topHeight+i*rightHeight;yPos=yPosLastEnd;drawHeight=Math.round(goalPos-yPos+rightHeight);context.setTransform(rightWidthRound/tiles.r.w,0,0,drawHeight/tiles.r.h,xPos,yPos);context.drawImage(tiles.r.img,0,0);yPosLastEnd=yPos+drawHeight}xPosLastEnd=leftWidthRound;yPos=h-bottomHeightRound;for(i=0;i<nBottom;i++){goalPos=leftWidth+i*bottomWidth;xPos=xPosLastEnd;drawWidth=Math.round(goalPos-xPos+bottomWidth);context.setTransform(drawWidth/tiles.b.w,0,0,bottomHeightRound/tiles.b.h,xPos,yPos);context.drawImage(tiles.b.img,0,0);xPosLastEnd=xPos+drawWidth}context.setTransform(1,0,0,1,0,0);_paintWidget.recomposite()};var _tileBorder=function(canvas,frameName,borderSize){_paintWidget.imageBorderManager.tileBorder(frameName,function(tilesObj){var knownBorderSizes={border1:.07,border2:.06,border3:.07,border4:.09,border5:.12,border6:.12,border7:.09,border8:.09,border9:.09,border11:.13,border12:.05,border13:.05};borderSize=borderSize||knownBorderSizes[frameName]||.1;_tileBorderApply(canvas,tilesObj,borderSize)})};var _runFrame=function(layerName,frameName,flatten){var layer=_paintWidget.getLayerByName(layerName);if(layer.canvas==null){return}_tileBorder(layer.canvas,frameName)};var _frameUndo=function(layerName){var i=_paintWidget.findLayerIndexByName(layerName);if(i!=-1){_paintWidget.layerDelete(i)}_paintWidget.recomposite()};var _frameRedo=function(layerName,frameName,flatten){_createLayerIfNecessary(layerName);_runFrame(layerName,frameName,flatten);_dirty=true};var _createLayerIfNecessary=function(name){name=name||_layerName;var layer=_paintWidget.getLayerByName(name);if(!layer){var dcanvas=document.createElement("canvas");dcanvas.width=_paintWidget.width;dcanvas.height=_paintWidget.height;layer=new AV.Layer({canvas:dcanvas,name:name});_paintWidget.addLayer(layer);_paintWidget.uiLayerReset()}if(layer.canvas.width!=_paintWidget.width){layer.canvas.width=_paintWidget.width}if(layer.canvas.height!=_paintWidget.height){layer.canvas.height=_paintWidget.height}return layer};api.activate=function(paintWidget){var randId=Math.floor(Math.random()*4294967295).toString(16);var name="_module_imageborder-"+randId;_layerName=name;_paintWidget=paintWidget;_dirty=false};api.deactivate=function(){_layerName=undefined;_dirty=false};api.applyPreview=function(frameName,flatten,callback){if(!_dirty){_paintWidget.actions.undoFake()}else{var layer=_paintWidget.getLayerByName(_layerName);if(layer&&layer.canvas){layer.canvas.width=layer.canvas.width}_paintWidget.actions.undoFake();_dirty=false}var hiResData={action:"imageborders",name:frameName,flatten:flatten};_paintWidget.dirty=true;_paintWidget.actions.push([_frameUndo,this,[_layerName]],[_frameRedo,this,[_layerName,frameName,flatten]],hiResData);AV.util.nextFrame(function(){_paintWidget.actions.redo();if(callback){callback()}})};api.makeThumb=function(canvas,frameName,borderSize){_tileBorder(canvas,frameName,borderSize)};api.readAction=function(data,next){if(data&&data.name){api.applyPreview(data.name,data.flatten,next)}else if(next){next.call(this)}};return api}();AV.PaintWidget.prototype.module["colorsplash"]=function(){var _paintWidget;var api={};var _origSrc,_newPixelData,src,dst,_tmp,_mask;var _processor;var _sessionAction;var _canvasBackingBeforeStroke;var _oldLayers;var _BRUSH_MODE_SETTINGS={smart:{IS_FREE_HAND:false,SIGMA_COLOR:10,REVERSE:0},free:{IS_FREE_HAND:true,SIGMA_COLOR:99999999,REVERSE:0},erase:{IS_FREE_HAND:true,SIGMA_COLOR:99999999,REVERSE:1}};var _initializeImageDataFromCanvas=function(flatten){flatten||(flatten=true);var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];if(layer.canvas==null){return}if(flatten){_oldLayers=_paintWidget.duplicateAllLayers();_paintWidget.flattenAllLayers();layer=_paintWidget.layers[_paintWidget.currentLayerIndex]}var dcanvas=AV.cnvs.copyCanvas(layer.canvas);var ctx=layer.canvas.getContext("2d");var w=_paintWidget.width,h=_paintWidget.height;_origSrc=AV.cnvs.getCanvasPixelData(dcanvas);src=_origSrc.data;_newPixelData=AV.cnvs.getCanvasPixelData(dcanvas);dst=_newPixelData.data;_tmp=AV.cnvs.getCanvasPixelData(dcanvas).data;var copyProcessor=AV.require("../../../src/js/processors/copy");_mask=copyProcessor.makeData(w*h);_processor=_processor||AV.require("../../../src/js/processors/tools/colorsplash");_processor.init(_tmp,w,h,_mask);_processor.preview(dst,src,_tmp,_mask,w,h);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite();return layer};var applyImage=function(imageData){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];layer.canvas.getContext("2d").putImageData(imageData,0,0);_paintWidget.recomposite()};api.getBrushSettingsForMode=function(mode){return _BRUSH_MODE_SETTINGS[mode]};api.commit=function(){_paintWidget.actions.push([applyImage,this,[_origSrc]],[applyImage,this,[_newPixelData]],_sessionAction);_paintWidget.actions.redoFake()};api.recordStroke=function(stroke){_sessionAction.strokes.push(stroke)};api.applySplash=function(x,y,startX,startY,reverse,sigmaR,sigmaC,alpha){var mask={};var w=_paintWidget.width,h=_paintWidget.height;_processor=_processor||AV.require("../../../src/js/processors/tools/selectsat");_processor.draw(src,w,h,_mask,{posX:x,posY:y,startX:startX,startY:startY,addMask:reverse,radius:sigmaR,sigmaC:sigmaC,alpha:1})};api.preview=function(minX,minY,maxX,maxY){var w=_paintWidget.width,h=_paintWidget.height;_processor.preview(dst,src,_tmp,_mask,w,h,minX,minY,maxX,maxY);var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};api.reset=function(){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");ctx.putImageData(_origSrc,0,0);_paintWidget.recomposite()};api.getColorAtPosition=function(x,y){x=Math.floor(x);y=Math.floor(y);var w=_paintWidget.width;var h=_paintWidget.height;if(x<0){x=0}else if(x>w-1){x=w-1}if(y<0){y=0}else if(y>h-1){y=h-1}if(src){var red=src[(w*y+x)*4];var green=src[(w*y+x)*4+1];var blue=src[(w*y+x)*4+2];var alpha=src[(w*y+x)*4+3]}return[red,green,blue,alpha]};api.initImage=function(){_initializeImageDataFromCanvas()};api.activate=function(paintWidget){_paintWidget=paintWidget;_sessionAction={action:"tools",toolname:"colorsplash",strokes:[]}};api.deactivate=function(){_processor=null};api.readAction=function(data,next){var i,j,stroke,point,strokeLen,strokePointsLen,startX,startY;if(data&&data.strokes){strokeLen=data.strokes.length;if(strokeLen>0){api.initImage();for(i=0;i<strokeLen;i++){stroke=data.strokes[i];api.recordStroke(stroke);if(stroke.pointlist){strokePointsLen=stroke.pointlist.length;for(j=0;j<strokePointsLen;j++){point=stroke.pointlist[j];if(j===0||stroke.brushmode==="free"){startX=point[0];startY=point[1]}api.applySplash(point[0],point[1],startX,startY,_BRUSH_MODE_SETTINGS[stroke.brushmode].REVERSE,stroke.radius,_BRUSH_MODE_SETTINGS[stroke.brushmode].SIGMA_COLOR,1)}}}api.preview(0,0,_paintWidget.width,_paintWidget.height);api.commit()}}if(next){next.call(this)}};api.resetImageData=function(){_initializeImageDataFromCanvas(true)};return api}();AV.PaintWidget.prototype.module["focus"]=function(){var _paintWidget;var api={};var _sessionAction;var _origSrc,_newPixelData,src,dst,_tmp,_mask;var _processor;var _initializeImageDataFromCanvas=function(){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];if(layer.canvas==null){return}var dcanvas=AV.cnvs.copyCanvas(layer.canvas);var ctx=layer.canvas.getContext("2d");var w=_paintWidget.width,h=_paintWidget.height;_origSrc=AV.cnvs.getCanvasPixelData(dcanvas);src=_origSrc.data;_newPixelData=AV.cnvs.getCanvasPixelData(dcanvas);dst=_newPixelData.data;_tmp=AV.cnvs.getCanvasPixelData(dcanvas).data;var copyProcessor=AV.require("../../../src/js/processors/copy");_mask=copyProcessor.makeData(w*h);_processor=_processor||AV.require("../../../src/js/processors/tools/tiltshift");_processor.init(_tmp,w,h,_mask);_processor.preview(dst,src,_tmp,_mask,w,h);ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};var _preview=function(){var w=_paintWidget.width,h=_paintWidget.height;_processor.preview(dst,src,_tmp,_mask,w,h,0,0,w,h);var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");ctx.putImageData(_newPixelData,0,0);_paintWidget.recomposite()};api.applyLinearBlur=function(x,y,sigmaR,angle){_processor=_processor||AV.require("../../../src/js/processors/tools/tiltshift");var w=_paintWidget.width,h=_paintWidget.height;_processor.draw(dst,w,h,_mask,{tiltshiftMode:"linear",posX:x,posY:y,sigmaR:sigmaR,angle:angle});_sessionAction={action:"tools",toolname:"tiltshift",x:x,y:y,radius:sigmaR,angle:angle*(180/Math.PI),tiltshiftmode:"linear"};_preview()};api.applyRadialBlur=function(x,y,sigmaR){_processor=_processor||AV.require("../../../src/js/processors/tools/tiltshift");var w=_paintWidget.width,h=_paintWidget.height;_processor.draw(dst,w,h,_mask,{tiltshiftMode:"radial",posX:x,posY:y,sigmaR:sigmaR});_sessionAction={action:"tools",toolname:"tiltshift",x:x,y:y,radius:sigmaR,tiltshiftmode:"radial"};_preview()};var applyImage=function(imageData){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];layer.canvas.getContext("2d").putImageData(imageData,0,0);_paintWidget.recomposite()};api.commit=function(){_paintWidget.actions.push([applyImage,this,[_origSrc]],[applyImage,this,[_newPixelData]],_sessionAction);_paintWidget.actions.redoFake()};api.reset=function(){var layer=_paintWidget.layers[_paintWidget.currentLayerIndex];var ctx=layer.canvas.getContext("2d");ctx.putImageData(_origSrc,0,0);_paintWidget.recomposite()};api.readAction=function(data,next){var i,len,point;if(data&&data.tiltshiftmode&&data.x&&data.y&&data.radius){if(data.tiltshiftmode==="radial"){api.applyRadialBlur(data.x,data.y,data.radius)}else{api.applyLinearBlur(data.x,data.y,data.radius,data.angle)}}api.commit();if(next){next.call(this)}};api.activate=function(paintWidget){_paintWidget=paintWidget;_initializeImageDataFromCanvas()};api.deactivate=function(){_processor=null};api.resetImageData=function(){_initializeImageDataFromCanvas(true)};return api}();AV.PaintWidget.prototype.module["drawing"]=function(){var _paintWidget;var _width=10,_color="#ffffff",_erase=false;var _brushModule=new AV.BrushModule({overflow:10,preserveBacking:true});var api=AV.util?AV.util.extend({},_brushModule):{};api.activate=function(paintWidget){_paintWidget=paintWidget;_brushModule.activate(_paintWidget)};api.apply=function(x,y){_brushModule.commit("drawing")};api.width=function(){return _width};api.setWidth=function(width){_width=width;_brushModule.setRadius(_width/2)};api.color=function(){return _color};api.setColor=function(color){_color=color;_brushModule.setColor(_color)};api.erase=function(){return _erase};api.setErase=function(erase){_erase=erase;_brushModule.setErase(_erase)};api.flatten=function(){_paintWidget.flattenAllLayers()};api.readAction=function(data,next){var i,len,point;if(data&&data.color&&data.radius&&data.pointlist){len=data.pointlist.length;api.setErase(data.erase);api.setColor(data.color);api.setWidth(2*data.radius);for(i=0;i<len;i++){point=data.pointlist[i];if(i===0){api.updateUIDown(point[0],point[1])}else{api.updateUIDraw(point[0],point[1])}}api.apply()}if(next){next.call(this)}};return api}();AV.SpotModule=function(o){var api={};var _processorParams=AV.util.extend({addMask:1,alpha:1},o.params);var _paintWidget;var _toolName=o.processorName;var _processor=AV.require("../../../src/js/processors/tools/"+_toolName);var _brushModule=new AV.SpotBrushModule({toolName:_toolName,processor:_processor,params:_processorParams});var api=AV.util?AV.util.extend({},_brushModule):{};api.activate=function(paintWidget){_paintWidget=paintWidget;_brushModule.activate(_paintWidget)};api.deactivate=function(){_processor=null;_brushModule.deactivate()};api.setParam=function(name,value){_processorParams[name]=value};api.readAction=function(data,next){var i,j,stroke,point,strokeLen,strokePointsLen,startX,startY;if(data&&data.strokes){strokeLen=data.strokes.length;api.activate(_paintWidget);if(strokeLen>0){api.reset();for(i=0;i<strokeLen;i++){stroke=data.strokes[i];var radius=stroke.radius;api.setRadius(radius);var zoomScale=AV.controlsWidgetInstance.canvasUI.viewport.getRatio();var scaledRadius=radius*zoomScale;if(stroke.pointlist){strokePointsLen=stroke.pointlist.length;api.startStroke();for(j=0;j<strokePointsLen;j++){point=stroke.pointlist[j];api.drawPoint(point[0],point[1],point[0],point[1],radius)}api.finializeStroke(radius)}}_paintWidget.actions.push([null,null,[]],[null,null,[]],api.getFlattenedActionList());_paintWidget.actions.redoFake()}}if(next){next.call(this)}};return api};AV.PaintWidget.prototype.module["blemish"]=new AV.SpotModule({processorName:"blemish",params:{alpha:.5}});AV.PaintWidget.prototype.module["redeye"]=new AV.SpotModule({processorName:"redeye",params:{alpha:.5}});AV.PaintWidget.prototype.module["whiten"]=new AV.SpotModule({processorName:"whiten",params:{alpha:.5}})}(window["AV"]||(window["AV"]={}),window,document);